<!DOCTYPE html>
<html lang="en">
<head> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hitex Editex</title>
<script src="Embednav.js" defer></script>
<link rel="stylesheet" href="invoice.css">
<script src="social.js" defer></script>
<script src="freshtex.js" defer></script> 
<link rel="stylesheet" href="ser_them.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" defer>
<link rel="stylesheet" href="fresh.css">  
<link rel="stylesheet" href="Embednav.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head> 
<body>

    <!-- <header class="pag-2-hed-1">
                <div class="lat_clo_001">              
                <a href="index.html" class="action-home"> 
                  <i class="fa-solid fa-house"></i>
               </a>  
                </div>  
                <div class="lat_clo_002">
                <button class="toggle-button-2" onclick="toggleLanguageList()">En &#9776;</button> 
                <ul class="language-list" id="languagelist">
                    <li>
                        <a href="/zh/home.html" class="language-link" data-lang="chinese">中文</a>
                    </li>
                    <li>
                        <a href="/fr/home.html" class="language-link" data-lang="french">Français</a>
                    </li>
                    <li>
                        <a href="/es/home.html" class="language-link" data-lang="spanish">Español</a>
                    </li>
                    <li>
                        <a href="/ja/home.html" class="language-link" data-lang="japanese">日本語</a>
                    </li>
                    <li>
                        <a href="/ar/home.html" class="language-link" data-lang="arabian">عربي</a>
                    </li>
                    <li>
                        <a href="/pt/home.html" class="language-link" data-lang="portuguese">Português</a>
                    </li>
                    <li>
                        <a href="/kor/home.html" class="language-link" data-lang="japanese">한국어</a>
                    </li>
                </ul>
            </div>
    </header> -->
              <!-- Modified Navigation HTML -->
               
<nav class="nav__bar_oi">
  <div class="nav__bar_oi-logo">
    <a href="index.html"><img src="assets/png_20221026_003820_0000.png" alt="HiTex EdiTex Logo"></a>
  </div>
  
  <button class="nav__bar_oi-toggle" id="navToggle">
    <span class="nav__bar_oi-toggle-line"></span>
    <span class="nav__bar_oi-toggle-line"></span>
    <span class="nav__bar_oi-toggle-line"></span>
  </button>
  
  <ul class="nav__bar_oi-menu" id="navMenu">
    <li class="nav__bar_oi-menu-item">
      <a href="#" class="nav__bar_oi-menu-link">About Us</a>
      <div class="nav__bar_oi-dropdown">
        <a href="about.html" class="nav__bar_oi-dropdown-item">About HiTex EdiTex</a>
        <a href="leadership.html" class="nav__bar_oi-dropdown-item">Leadership</a>
        <!-- <a href="#offices" class="nav__bar_oi-dropdown-item">Offices</a> -->
        <!-- <a href="impact.html" class="nav__bar_oi-dropdown-item">Impact</a> -->
      </div>
    </li>
    <li class="nav__bar_oi-menu-item">
      <a href="#services" class="nav__bar_oi-menu-link">Services</a>
      <div class="nav__bar_oi-dropdown">
        <a href="language-editng.html" class="nav__bar_oi-dropdown-item">Language Editing</a>
        <a href="Scientific.html" class="nav__bar_oi-dropdown-item">Scientific Editing</a>
        <a href="technichal.html" class="nav__bar_oi-dropdown-item">Technical Editing</a>
        <a href="translate.html" class="nav__bar_oi-dropdown-item">Translation Services</a>
        <a href="service-levels.html" class="nav__bar_oi-dropdown-item">Service Levels</a>
        <a href="pricing.html" class="nav__bar_oi-dropdown-item">Pricing</a>
        <a href="auhtoredly.html" class="nav__bar_oi-dropdown-item">Authoredly</a>
      </div>
    </li>
    <li class="nav__bar_oi-menu-item">
      <a href="#careers" class="nav__bar_oi-menu-link">Careers</a>
      <div class="nav__bar_oi-dropdown">
        <a href="life-at-hitex.html" class="nav__bar_oi-dropdown-item">Life at HiTex EdiTex</a>
        <a href="In-house.html" class="nav__bar_oi-dropdown-item">In-house</a>
        <a href="freelance.html" class="nav__bar_oi-dropdown-item">Freelance</a>
         <a href="admin-login.html" class="nav__bar_oi-dropdown-item">ad</a>
      </div>
    </li>
    <li class="nav__bar_oi-menu-item">
      <a href="contact.html" class="nav__bar_oi-menu-link">Contact Us</a>
    </li>
    <li class="nav__bar_oi-menu-item">
      <a href="#resources" class="nav__bar_oi-menu-link">Helpful Resources</a>
      <div class="nav__bar_oi-dropdown">
        <a href="support-faq.html" class="nav__bar_oi-dropdown-item">Support and FAQs</a>
        <a href="hitex-hub.html" class="nav__bar_oi-dropdown-item">The Hitex Hub</a>
        <!-- <a href="newsroom.html" class="nav__bar_oi-dropdown-item">Newsroom</a> -->
      </div>
    </li>
    <div class="nav__bar_oi-actions">
      <button class="nav__bar_oi-button nav__bar_oi-button-signup">Client Sign-Up</button>
      <button class="nav__bar_oi-button nav__bar_oi-button-login">Client Log-in</button>
    </div>
   
    <div class="xzy-container-88">
     <div class="qrs-icon-hold-42">
        <a href="https://www.threads.net/@hitexeditex">
            <img src="assets/threads-icon.svg" class="pqr-img-elem-91" alt="Threads Icon">
        </a>
    </div>
    <div class="qrs-icon-hold-42">
        <a href="https://www.linkedin.com/company/hitexeditex/">
            <img src="assets/linkedin-app-icon.svg" class="pqr-img-elem-91" alt="LinkedIn Icon">
        </a>
    </div>
    <div class="qrs-icon-hold-42">
        <a href="https://x.com/HiTexEdiTex" target="_blank">
            <img src="assets/x-social-media-black-icon.svg" class="pqr-img-elem-91" alt="X Icon">
        </a>
    </div>
    <div class="qrs-icon-hold-42">
        <a href="https://www.instagram.com/hitexeditex" target="_blank">
            <img src="assets/ig-instagram-icon.svg" class="pqr-img-elem-91" alt="Instagram Icon">
        </a>
    </div>
</div>
  </ul>
  
  <!-- Search bar and social media icons -->
  <div class="nav__bar_oi-utility">
    <div class="nav__bar_oi-search">
      <button class="nav__bar_oi-search-icon" id="searchToggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
      <div class="nav__bar_oi-search-container" id="searchContainer">
        <input type="text" class="nav__bar_oi-search-input" placeholder="Search..." aria-label="Search">
        <button class="nav__bar_oi-search-close" id="searchClose">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
    <div class="nav__bar_oi-social">
      <div class="new_loger_nav__bar_oi-actions">
        <a href="client-sign-up.html" class="new_loger_nav__bar_oi-button new_loger_nav__bar_oi-button-signup">Client Sign-up</a>
        <a href="client-login.html" class="new_loger_nav__bar_oi-button new_loger_nav__bar_oi-button-login">Client Log-in</a>
      </div>
                        <div class="kli_002_wer">
                            <a href="https://www.threads.net/@hitexeditex">
                            <img src="assets/threads-icon.svg" class="alb-im-001">
                           </a>
                        </div>
                           
                        <div class="kli_002_wer">
                    <a href="https://www.linkedin.com/company/hitexeditex/">
                    <img src="assets/linkedin-app-icon.svg" class="alb-im-001">
                   </a>
                   </div>
                   <div class="kli_002_wer">
                   <a href="https://x.com/HiTexEdiTex" target="_blank">
                    <img src="assets/x-social-media-black-icon.svg" alt="Twitter Icon" class="alb-im-001">
                  </a>
                  </div>  
                  <div class="kli_002_wer">
                   <a href="https://www.instagram.com/hitexeditex" target="_blank"  >
                    <img src="assets/ig-instagram-icon.svg" class="alb-im-001"></a>
                    </div>  
    </div>
  </div>
  
  <div class="nav__bar_oi-overlay" id="navOverlay"></div>
</nav>

  

    <div class="invoice-container">
        <!-- Status Alerts -->
        <div id="statusAlerts"></div>

        <!-- Invoice Header -->
        <div class="invoice-header">
            <div class="company-info">
                <h2>HiTex EdiTex</h2>
                <p>Professional Manuscript Editing Services</p>
                <p>Email: support@hitexeditex.com</p>
                <p>Website: www.hitexeditex.com</p>
            </div>
            <div class="invoice-details">
                <div class="invoice-number">Invoice #<span id="invoiceNumber">Loading...</span></div>
                <p>Date: <span id="invoiceDate">Loading...</span></p>
                <p>Due Date: <span id="dueDate">Loading...</span></p>
                <p>Status: <span id="invoiceStatus" class="badge">Pending</span></p>
            </div>
        </div>

        <!-- Billing Information -->
        <div class="billing-section">
            <div class="billing-info">
                <h4>Bill To:</h4>
                <div id="billingAddress">
                    <p id="clientName">Loading...</p>
                    <p id="clientEmail">Loading...</p>
                    <p id="clientInstitution">Loading...</p>
                </div>
            </div>
            <div class="billing-info">
                <h4>Service Details:</h4>
                <div id="serviceDetails">
                    <p><strong>Manuscript:</strong> <span id="manuscriptTitle">Loading...</span></p>
                    <p><strong>Service Type:</strong> <span id="serviceType">Loading...</span></p>
                    <p><strong>Word Count:</strong> <span id="wordCount">Loading...</span></p>
                    <p><strong>Turnaround:</strong> <span id="turnaround">Loading...</span></p>
                </div>
            </div>
        </div>

        <!-- Discount Section -->
        <div class="discount-section" id="discountSection">
            <h4><i class="fas fa-gift"></i> Apply Discount Code</h4>
            <p>Have a discount code? Enter it below to save on your order!</p>
            <div class="discount-input">
                <input type="text" id="discountCodeInput" placeholder="Enter discount code" maxlength="20">
                <button class="apply-discount-btn" onclick="applyDiscountCode()">Apply</button>
            </div>
            <div id="discountMessage"></div>
        </div>

        <!-- Services Table -->
        <table class="services-table">
            <thead>
                <tr>
                    <th>Service Description</th>
                    <th>Quantity</th>
                    <th>Rate</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody id="servicesTableBody">
                <!-- Services will be populated by JavaScript -->
            </tbody>
        </table>

        <!-- Total Section -->
        <div class="total-section">
            <div class="total-row">
                <span>Subtotal:</span>
                <span id="subtotalAmount">$0.00</span>
            </div>
            <div class="total-row" id="discountRow" style="display: none;">
                <span class="discount-applied">Discount (<span id="discountPercent">0</span>%):</span>
                <span class="discount-applied">-$<span id="discountAmount">0.00</span></span>
            </div>
            <div class="total-row">
                <span>Tax (0%):</span>
                <span id="taxAmount">$0.00</span>
            </div>
            <div class="total-row final">
                <span>Total:</span>
                <span id="totalAmount">$0.00</span>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>Processing payment...</p>
        </div>

        <!-- Payment Section -->
        <div class="payment-section" id="paymentSection">
            <h3><i class="fas fa-credit-card"></i> Secure Payment</h3>
            <p>Choose your preferred payment method below. All transactions are encrypted and secure.</p>

            <!-- Payment Methods -->
            <div class="payment-methods">
                <div class="payment-method" data-method="card" onclick="selectPaymentMethod('card')">
                    <h4><i class="fas fa-credit-card"></i> Credit/Debit Card</h4>
                    <p>Visa, MasterCard, American Express</p>
                </div>
                <div class="payment-method" data-method="paypal" onclick="selectPaymentMethod('paypal')">
                    <h4><i class="fab fa-paypal"></i> PayPal</h4>
                    <p>Pay securely with your PayPal account</p>
                </div>
                <div class="payment-method" data-method="bank" onclick="selectPaymentMethod('bank')">
                    <h4><i class="fas fa-university"></i> Bank Transfer</h4>
                    <p>Direct bank transfer (ACH)</p>
                </div>
            </div>

            <!-- Card Payment Form -->
            <div class="payment-form" id="cardPaymentForm">
                <h4>Card Information</h4>
                <div class="form-group">
                    <label for="cardNumber">Card Number</label>
                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="expiryDate">Expiry Date</label>
                        <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5">
                    </div>
                    <div class="form-group">
                        <label for="cvv">CVV</label>
                        <input type="text" id="cvv" placeholder="123" maxlength="4">
                    </div>
                </div>
                <div class="form-group">
                    <label for="cardName">Name on Card</label>
                    <input type="text" id="cardName" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label for="billingZip">Billing ZIP Code</label>
                    <input type="text" id="billingZip" placeholder="12345">
                </div>
                
                <div class="security-badges">
                    <div class="security-badge">
                        <i class="fas fa-lock"></i>
                        <span>256-bit SSL Encryption</span>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>PCI Compliant</span>
                    </div>
                </div>
                
                <button class="pay-button" onclick="processPayment('card')" id="cardPayButton">
                    <i class="fas fa-lock"></i> Pay Securely $<span id="cardPayAmount">0.00</span>
                </button>
            </div>

            <!-- PayPal Payment Form -->
            <div class="payment-form" id="paypalPaymentForm">
                <h4>PayPal Payment</h4>
                <p>You will be redirected to PayPal to complete your payment securely.</p>
                <div class="security-badges">
                    <div class="security-badge">
                        <i class="fab fa-paypal"></i>
                        <span>PayPal Buyer Protection</span>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>Secure Transaction</span>
                    </div>
                </div>
                <button class="pay-button" onclick="processPayment('paypal')" id="paypalPayButton">
                    <i class="fab fa-paypal"></i> Pay with PayPal $<span id="paypalPayAmount">0.00</span>
                </button>
            </div>

            <!-- Bank Transfer Payment Form -->
            <div class="payment-form" id="bankPaymentForm">
                <h4>Bank Transfer (ACH)</h4>
                <div class="form-group">
                    <label for="bankAccountType">Account Type</label>
                    <select id="bankAccountType">
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="routingNumber">Routing Number</label>
                    <input type="text" id="routingNumber" placeholder="123456789" maxlength="9">
                </div>
                <div class="form-group">
                    <label for="accountNumber">Account Number</label>
                    <input type="text" id="accountNumber" placeholder="Account Number">
                </div>
                <div class="form-group">
                    <label for="accountHolderName">Account Holder Name</label>
                    <input type="text" id="accountHolderName" placeholder="John Doe">
                </div>
                
                <div class="security-badges">
                    <div class="security-badge">
                        <i class="fas fa-university"></i>
                        <span>Bank-level Security</span>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-lock"></i>
                        <span>Encrypted Transfer</span>
                    </div>
                </div>
                
                <button class="pay-button" onclick="processPayment('bank')" id="bankPayButton">
                    <i class="fas fa-university"></i> Authorize Payment $<span id="bankPayAmount">0.00</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const API_BASE = 'https://all-branched-end.onrender.com';
        let currentInvoice = null;
        let selectedPaymentMethod = null;
        let appliedDiscount = null;

        // Initialize invoice page
        document.addEventListener('DOMContentLoaded', async () => {
            if (!validateSession()) return;
            
            const invoiceId = getInvoiceIdFromURL();
            if (invoiceId) {
                await loadInvoice(invoiceId);
            } else {
                await loadDraftInvoice();
            }
            
            setupInputFormatting();
        });

        // Session validation
        function validateSession() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.replace('client-login.html');
                return false;
            }
            return true;
        }

        // Get invoice ID from URL parameters
        function getInvoiceIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Load existing invoice
        async function loadInvoice(invoiceId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/invoice/${invoiceId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    currentInvoice = await response.json();
                    populateInvoiceData(currentInvoice);
                } else {
                    showAlert('error', 'Invoice not found or access denied.');
                }
            } catch (error) {
                console.error('Error loading invoice:', error);
                showAlert('error', 'Failed to load invoice. Please try again.');
            }
        }

        // Load draft invoice (for new services)
        async function loadDraftInvoice() {
            try {
                const token = localStorage.getItem('authToken');
                
                // Get user profile
                const profileResponse = await fetch(`${API_BASE}/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const profile = await profileResponse.json();

                // Create draft invoice
                currentInvoice = {
                    invoiceNumber: 'DRAFT-' + Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: 'pending',
                    client: profile,
                    services: [
                        {
                            description: 'Professional Manuscript Editing',
                            quantity: 1,
                            rate: 250.00,
                            amount: 250.00
                        }
                    ],
                    subtotal: 250.00,
                    tax: 0.00,
                    total: 250.00
                };

                populateInvoiceData(currentInvoice);
            } catch (error) {
                console.error('Error creating draft invoice:', error);
                showAlert('error', 'Failed to create invoice. Please try again.');
            }
        }

        // Populate invoice data in the UI
        function populateInvoiceData(invoice) {
            // Invoice details
            document.getElementById('invoiceNumber').textContent = invoice.invoiceNumber;
            document.getElementById('invoiceDate').textContent = formatDate(invoice.date);
            document.getElementById('dueDate').textContent = formatDate(invoice.dueDate);
            document.getElementById('invoiceStatus').textContent = invoice.status;

            // Client information
            document.getElementById('clientName').textContent = invoice.client.fullName || `${invoice.client.firstName} ${invoice.client.lastName}`;
            document.getElementById('clientEmail').textContent = invoice.client.email;
            document.getElementById('clientInstitution').textContent = invoice.client.currentInstitution || 'N/A';

            // Service details (if available)
            if (invoice.manuscript) {
                document.getElementById('manuscriptTitle').textContent = invoice.manuscript.title || 'Professional Editing Service';
                document.getElementById('serviceType').textContent = invoice.manuscript.serviceType || 'Standard Editing';
                document.getElementById('wordCount').textContent = invoice.manuscript.wordCount || 'N/A';
                document.getElementById('turnaround').textContent = invoice.manuscript.turnaround || '7-10 business days';
            } else {
                document.getElementById('manuscriptTitle').textContent = 'Professional Editing Service';
                document.getElementById('serviceType').textContent = 'Standard Editing';
                document.getElementById('wordCount').textContent = 'TBD';
                document.getElementById('turnaround').textContent = '7-10 business days';
            }

            // Services table
            const tbody = document.getElementById('servicesTableBody');
            tbody.innerHTML = '';
            invoice.services.forEach(service => {
                const row = `
                    <tr>
                        <td>${service.description}</td>
                        <td>${service.quantity}</td>
                        <td>$${service.rate.toFixed(2)}</td>
                        <td>$${service.amount.toFixed(2)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update totals
            updateTotals();
            
            // Load user's eligible discount codes
            loadEligibleDiscounts();
        }

        // Load user's eligible discount codes
        async function loadEligibleDiscounts() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/my-discount-codes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const codes = await response.json();
                    const activeCode = codes.find(code => 
                        !code.isUsed && new Date(code.expiresAt) > new Date()
                    );

                    if (activeCode) {
                        // Auto-populate the discount code field
                        document.getElementById('discountCodeInput').value = activeCode.code;
                        showAlert('success', `You have an active ${activeCode.discountPercentage}% discount code! It has been automatically applied below.`);
                    }
                }
            } catch (error) {
                console.error('Error loading discount codes:', error);
            }
        }

        // Apply discount code
        async function applyDiscountCode() {
            const discountCode = document.getElementById('discountCodeInput').value.trim();
            
            if (!discountCode) {
                showAlert('warning', 'Please enter a discount code.');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/validate-discount-code`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        discountCode: discountCode,
                        orderAmount: currentInvoice.subtotal
                    })
                });

                const result = await response.json();

                if (result.valid) {
                    appliedDiscount = result;
                    currentInvoice.discount = result;
                    currentInvoice.total = result.finalAmount;
                    
                    updateTotals();
                    showAlert('success', `Discount applied! You saved $${result.discountAmount.toFixed(2)} (${result.discountPercentage}%)`);
                } else {
                    showAlert('error', result.error || 'Invalid discount code.');
                }
            } catch (error) {
                console.error('Error applying discount:', error);
                showAlert('error', 'Failed to apply discount code. Please try again.');
            }
        }

        // Update totals display
        function updateTotals() {
            document.getElementById('subtotalAmount').textContent = `$${currentInvoice.subtotal.toFixed(2)}`;
            
            if (currentInvoice.discount) {
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('discountPercent').textContent = currentInvoice.discount.discountPercentage;
                document.getElementById('discountAmount').textContent = currentInvoice.discount.discountAmount.toFixed(2);
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }
            
            document.getElementById('taxAmount').textContent = `$${currentInvoice.tax.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${currentInvoice.total.toFixed(2)}`;
            
            // Update payment button amounts
            document.querySelectorAll('[id$="PayAmount"]').forEach(element => {
                element.textContent = currentInvoice.total.toFixed(2);
            });
        }

        // Select payment method
        function selectPaymentMethod(method) {
            // Remove previous selections
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelectorAll('.payment-form').forEach(el => {
                el.style.display = 'none';
            });

            // Select current method
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');
            document.getElementById(`${method}PaymentForm`).style.display = 'block';
            selectedPaymentMethod = method;
        }

        // Setup input formatting
        function setupInputFormatting() {
            // Card number formatting
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || '';
                e.target.value = formattedValue;
            });

            // Expiry date formatting
            document.getElementById('expiryDate').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });

            // CVV formatting (numbers only)
            document.getElementById('cvv').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });

            // Routing number formatting (numbers only)
            document.getElementById('routingNumber').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });

            // Account number formatting (numbers only)
            document.getElementById('accountNumber').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        }

        // Process payment
        async function processPayment(method) {
            if (!selectedPaymentMethod) {
                showAlert('warning', 'Please select a payment method.');
                return;
            }

            // Validate payment form
            if (!validatePaymentForm(method)) {
                return;
            }

            // Show loading
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('paymentSection').style.display = 'none';

            // Disable all payment buttons
            document.querySelectorAll('.pay-button').forEach(btn => {
                btn.disabled = true;
            });

            try {
                const paymentData = await preparePaymentData(method);
                const token = localStorage.getItem('authToken');

                const response = await fetch(`${API_BASE}/process-payment`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Mark discount as used if applicable
                    if (appliedDiscount && appliedDiscount.discountId) {
                        await markDiscountAsUsed(appliedDiscount.discountId, {
                            transactionId: result.transactionId,
                            amount: currentInvoice.total,
                            method: method
                        });
                    }

                    // Redirect to success page
                    window.location.href = `payment-success.html?transaction=${result.transactionId}&invoice=${currentInvoice.invoiceNumber}`;
                } else {
                    throw new Error(result.error || 'Payment processing failed');
                }

            } catch (error) {
                console.error('Payment processing error:', error);
                showAlert('error', `Payment failed: ${error.message}`);
                
                // Hide loading and show payment section again
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('paymentSection').style.display = 'block';
                
                // Re-enable payment buttons
                document.querySelectorAll('.pay-button').forEach(btn => {
                    btn.disabled = false;
                });
            }
        }

        // Validate payment form based on method
        function validatePaymentForm(method) {
            switch (method) {
                case 'card':
                    return validateCardForm();
                case 'paypal':
                    return validatePayPalForm();
                case 'bank':
                    return validateBankForm();
                default:
                    return false;
            }
        }

        // Validate card payment form
        function validateCardForm() {
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expiryDate = document.getElementById('expiryDate').value;
            const cvv = document.getElementById('cvv').value;
            const cardName = document.getElementById('cardName').value.trim();
            const billingZip = document.getElementById('billingZip').value.trim();

            if (cardNumber.length < 13 || cardNumber.length > 19) {
                showAlert('error', 'Please enter a valid card number.');
                document.getElementById('cardNumber').focus();
                return false;
            }

            if (!expiryDate.match(/^(0[1-9]|1[0-2])\/\d{2}$/)) {
                showAlert('error', 'Please enter a valid expiry date (MM/YY).');
                document.getElementById('expiryDate').focus();
                return false;
            }

            // Check if card is expired
            const [month, year] = expiryDate.split('/');
            const expiry = new Date(2000 + parseInt(year), parseInt(month) - 1);
            if (expiry < new Date()) {
                showAlert('error', 'This card has expired.');
                document.getElementById('expiryDate').focus();
                return false;
            }

            if (cvv.length < 3 || cvv.length > 4) {
                showAlert('error', 'Please enter a valid CVV.');
                document.getElementById('cvv').focus();
                return false;
            }

            if (!cardName) {
                showAlert('error', 'Please enter the name on the card.');
                document.getElementById('cardName').focus();
                return false;
            }

            if (!billingZip || billingZip.length < 5) {
                showAlert('error', 'Please enter a valid billing ZIP code.');
                document.getElementById('billingZip').focus();
                return false;
            }

            return true;
        }

        // Validate PayPal form (minimal validation needed)
        function validatePayPalForm() {
            return true; // PayPal handles its own validation
        }

        // Validate bank transfer form
        function validateBankForm() {
            const routingNumber = document.getElementById('routingNumber').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const accountHolderName = document.getElementById('accountHolderName').value.trim();

            if (routingNumber.length !== 9) {
                showAlert('error', 'Please enter a valid 9-digit routing number.');
                document.getElementById('routingNumber').focus();
                return false;
            }

            if (!accountNumber || accountNumber.length < 4) {
                showAlert('error', 'Please enter a valid account number.');
                document.getElementById('accountNumber').focus();
                return false;
            }

            if (!accountHolderName) {
                showAlert('error', 'Please enter the account holder name.');
                document.getElementById('accountHolderName').focus();
                return false;
            }

            return true;
        }

        // Prepare payment data based on method
        async function preparePaymentData(method) {
            const baseData = {
                invoiceId: currentInvoice.id || currentInvoice.invoiceNumber,
                amount: currentInvoice.total,
                method: method,
                currency: 'USD',
                discount: appliedDiscount
            };

            switch (method) {
                case 'card':
                    return {
                        ...baseData,
                        cardData: {
                            number: document.getElementById('cardNumber').value.replace(/\s/g, ''),
                            expiry: document.getElementById('expiryDate').value,
                            cvv: document.getElementById('cvv').value,
                            name: document.getElementById('cardName').value,
                            billingZip: document.getElementById('billingZip').value
                        }
                    };

                case 'paypal':
                    return {
                        ...baseData,
                        redirectUrl: window.location.origin + '/payment-success.html'
                    };

                case 'bank':
                    return {
                        ...baseData,
                        bankData: {
                            accountType: document.getElementById('bankAccountType').value,
                            routingNumber: document.getElementById('routingNumber').value,
                            accountNumber: document.getElementById('accountNumber').value,
                            accountHolderName: document.getElementById('accountHolderName').value
                        }
                    };

                default:
                    throw new Error('Invalid payment method');
            }
        }

        // Mark discount as used
        async function markDiscountAsUsed(discountId, paymentDetails) {
            try {
                const token = localStorage.getItem('authToken');
                await fetch(`${API_BASE}/mark-discount-used`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        discountId: discountId,
                        paymentDetails: paymentDetails
                    })
                });
            } catch (error) {
                console.error('Failed to mark discount as used:', error);
                // Don't throw error as payment was successful
            }
        }

        // Show status alert
        function showAlert(type, message) {
            const alertsContainer = document.getElementById('statusAlerts');
            const alertId = 'alert-' + Date.now();
            
            const alert = document.createElement('div');
            alert.id = alertId;
            alert.className = `status-alert ${type}`;
            alert.innerHTML = `
                <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
                <button onclick="dismissAlert('${alertId}')" style="float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer;">&times;</button>
            `;
            
            alertsContainer.appendChild(alert);
            
            // Auto dismiss after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => dismissAlert(alertId), 5000);
            }
            
            // Scroll to top to show alert
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Dismiss alert
        function dismissAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.remove();
            }
        }

        // Format date for display
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Print invoice
        function printInvoice() {
            window.print();
        }

        // Download invoice as PDF (placeholder - would need PDF generation library)
        function downloadInvoicePDF() {
            showAlert('info', 'PDF download feature coming soon!');
        }

        // Make functions available globally
        window.selectPaymentMethod = selectPaymentMethod;
        window.processPayment = processPayment;
        window.applyDiscountCode = applyDiscountCode;
        window.dismissAlert = dismissAlert;
        window.printInvoice = printInvoice;
        window.downloadInvoicePDF = downloadInvoicePDF;
    </script>

    <script src="discount-integration.js"></script>
    <script src="global-dashboard.js"></script>

</body>
</html>