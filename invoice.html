<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice & Payment - HiTex EdiTex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #667eea;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            line-height: 1.6;
            color: #333;
        }

        .nav__bar_oi {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 1rem 0;
            box-shadow: var(--shadow);
        }

        .nav__bar_oi .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav__bar_oi-logo img {
            height: 50px;
            width: auto;
        }

        .nav__bar_oi-button {
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .nav__bar_oi-button:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            text-decoration: none;
        }

        .invoice-container {
            max-width: 1000px;
            margin: 2rem auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .invoice-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
        }

        .invoice-header-content {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 2rem;
            align-items: start;
        }

        .company-info h1 {
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .company-info p {
            margin: 0.25rem 0;
            opacity: 0.9;
        }

        .invoice-details {
            text-align: right;
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .invoice-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.pending {
            background: var(--warning-color);
            color: #856404;
        }

        .status-badge.paid {
            background: var(--success-color);
            color: white;
        }

        .status-badge.overdue {
            background: var(--danger-color);
            color: white;
        }

        .invoice-body {
            padding: 2rem;
        }

        .billing-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .billing-card {
            background: var(--light-gray);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .billing-card h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .billing-card p {
            margin: 0.5rem 0;
        }

        .services-section {
            margin-bottom: 2rem;
        }

        .services-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .services-table th {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .services-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .services-table tbody tr:hover {
            background: var(--light-gray);
        }

        .services-table tbody tr:last-child td {
            border-bottom: none;
        }

        .discount-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
            border: 2px dashed var(--success-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .discount-input {
            display: flex;
            max-width: 400px;
            margin: 1rem auto;
            gap: 0.5rem;
        }

        .discount-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .apply-discount-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .apply-discount-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .totals-section {
            background: var(--light-gray);
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem auto;
            max-width: 400px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .total-row.final {
            border-top: 2px solid var(--primary-color);
            padding-top: 1rem;
            font-weight: bold;
            font-size: 1.3rem;
            color: var(--primary-color);
        }

        .discount-applied {
            color: var(--success-color);
            font-weight: 600;
        }

        .payment-section {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            margin-top: 2rem;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .payment-method {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .payment-method:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .payment-method.selected {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
            transform: translateY(-2px);
        }

        .payment-method i {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
        }

        .payment-form {
            background: white;
            color: #333;
            padding: 2rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control.is-invalid {
            border-color: var(--danger-color);
        }

        .security-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }

        .security-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success-color);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .pay-button {
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .pay-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4);
        }

        .pay-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-dismiss {
            position: absolute;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .alert-dismiss:hover {
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .invoice-container {
                margin: 1rem;
            }

            .invoice-header {
                padding: 1.5rem;
            }

            .invoice-header-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .invoice-details {
                text-align: left;
            }

            .invoice-body {
                padding: 1rem;
            }

            .billing-section {
                grid-template-columns: 1fr;
            }

            .services-table {
                font-size: 0.875rem;
            }

            .services-table th,
            .services-table td {
                padding: 0.75rem;
            }

            .totals-section {
                margin: 1rem 0;
            }

            .payment-section {
                padding: 1.5rem;
            }

            .payment-methods {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .invoice-header {
                padding: 1rem;
            }

            .invoice-body {
                padding: 1rem;
            }

            .payment-section {
                padding: 1rem;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .nav__bar_oi,
            .payment-section,
            .discount-section {
                display: none !important;
            }

            .invoice-container {
                box-shadow: none;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav__bar_oi">
        <div class="container">
            <div class="nav__bar_oi-logo">
                <a href="index.html">
                    <img src="assets/png_20221026_003820_0000.png" alt="HiTex EdiTex Logo">
                </a>
            </div>
            <div class="nav__bar_oi-utility">
                <a href="client-dashboard.html" class="nav__bar_oi-button">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="invoice-container">
        <!-- Status Alerts -->
        <div id="statusAlerts"></div>

        <!-- Invoice Header -->
        <div class="invoice-header">
            <div class="invoice-header-content">
                <div class="company-info">
                    <h1>HiTex EdiTex</h1>
                    <p><i class="fas fa-pen-fancy"></i> Professional Manuscript Editing Services</p>
                    <p><i class="fas fa-envelope"></i> support@hitexeditex.com</p>
                    <p><i class="fas fa-globe"></i> www.hitexeditex.com</p>
                </div>
                <div class="invoice-details">
                    <div class="invoice-number">
                        Invoice #<span id="invoiceNumber">Loading...</span>
                    </div>
                    <p><strong>Date:</strong> <span id="invoiceDate">Loading...</span></p>
                    <p><strong>Due Date:</strong> <span id="dueDate">Loading...</span></p>
                    <p><strong>Status:</strong> <span id="invoiceStatus" class="status-badge">Pending</span></p>
                </div>
            </div>
        </div>

        <div class="invoice-body">
            <!-- Billing Information -->
            <div class="billing-section">
                <div class="billing-card">
                    <h3><i class="fas fa-user"></i> Bill To</h3>
                    <div id="billingAddress">
                        <p><strong id="clientName">Loading...</strong></p>
                        <p><i class="fas fa-envelope"></i> <span id="clientEmail">Loading...</span></p>
                        <p><i class="fas fa-university"></i> <span id="clientInstitution">Loading...</span></p>
                    </div>
                </div>
                <div class="billing-card">
                    <h3><i class="fas fa-file-alt"></i> Service Details</h3>
                    <div id="serviceDetails">
                        <p><strong>Manuscript:</strong> <span id="manuscriptTitle">Loading...</span></p>
                        <p><strong>Service Type:</strong> <span id="serviceType">Loading...</span></p>
                        <p><strong>Word Count:</strong> <span id="wordCount">Loading...</span></p>
                        <p><strong>Turnaround:</strong> <span id="turnaround">Loading...</span></p>
                    </div>
                </div>
            </div>

            <!-- Discount Section -->
            <div class="discount-section" id="discountSection">
                <h3><i class="fas fa-gift"></i> Apply Discount Code</h3>
                <p>Have a discount code? Enter it below to save on your order!</p>
                <div class="discount-input">
                    <input 
                        type="text" 
                        id="discountCodeInput" 
                        class="form-control"
                        placeholder="Enter discount code" 
                        maxlength="20"
                        autocomplete="off"
                    >
                    <button class="apply-discount-btn" onclick="applyDiscountCode()">
                        <i class="fas fa-check"></i> Apply
                    </button>
                </div>
                <div id="discountMessage"></div>
            </div>

            <!-- Services Table -->
            <div class="services-section">
                <h3><i class="fas fa-list"></i> Services</h3>
                <table class="services-table">
                    <thead>
                        <tr>
                            <th>Service Description</th>
                            <th>Quantity</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                        <!-- Services will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Totals Section -->
            <div class="totals-section">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span id="subtotalAmount">$0.00</span>
                </div>
                <div class="total-row discount-applied" id="discountRow" style="display: none;">
                    <span>Discount (<span id="discountPercent">0</span>%):</span>
                    <span>-$<span id="discountAmount">0.00</span></span>
                </div>
                <div class="total-row">
                    <span>Tax (0%):</span>
                    <span id="taxAmount">$0.00</span>
                </div>
                <div class="total-row final">
                    <span>Total:</span>
                    <span id="totalAmount">$0.00</span>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <h4>Processing Payment...</h4>
                <p>Please wait while we securely process your transaction.</p>
            </div>

            <!-- Payment Section -->
            <div class="payment-section" id="paymentSection">
                <div class="text-center mb-4">
                    <h2><i class="fas fa-shield-alt"></i> Secure Payment</h2>
                    <p>Choose your preferred payment method below. All transactions are encrypted and secure.</p>
                </div>

                <!-- Payment Methods -->
                <div class="payment-methods">
                    <div class="payment-method" data-method="card" onclick="selectPaymentMethod('card')">
                        <i class="fas fa-credit-card"></i>
                        <h4>Credit/Debit Card</h4>
                        <p>Visa, MasterCard, American Express</p>
                    </div>
                    <div class="payment-method" data-method="paypal" onclick="selectPaymentMethod('paypal')">
                        <i class="fab fa-paypal"></i>
                        <h4>PayPal</h4>
                        <p>Pay securely with your PayPal account</p>
                    </div>
                    <div class="payment-method" data-method="bank" onclick="selectPaymentMethod('bank')">
                        <i class="fas fa-university"></i>
                        <h4>Bank Transfer</h4>
                        <p>Direct bank transfer (ACH)</p>
                    </div>
                </div>

                <!-- Card Payment Form -->
                <div class="payment-form" id="cardPaymentForm">
                    <h4><i class="fas fa-credit-card"></i> Card Information</h4>
                    <div class="form-group">
                        <label for="cardNumber">Card Number *</label>
                        <input type="text" id="cardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" autocomplete="cc-number">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiryDate">Expiry Date *</label>
                            <input type="text" id="expiryDate" class="form-control" placeholder="MM/YY" maxlength="5" autocomplete="cc-exp">
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV *</label>
                            <input type="password" id="cvv" class="form-control" placeholder="123" maxlength="4" autocomplete="cc-csc">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cardName">Name on Card *</label>
                        <input type="text" id="cardName" class="form-control" placeholder="John Doe" autocomplete="cc-name">
                    </div>
                    <div class="form-group">
                        <label for="billingZip">Billing ZIP Code *</label>
                        <input type="text" id="billingZip" class="form-control" placeholder="12345" maxlength="10" autocomplete="postal-code">
                    </div>
                    
                    <div class="security-badges">
                        <div class="security-badge">
                            <i class="fas fa-lock"></i>
                            <span>256-bit SSL Encryption</span>
                        </div>
                        <div class="security-badge">
                            <i class="fas fa-shield-alt"></i>
                            <span>PCI Compliant</span>
                        </div>
                        <div class="security-badge">
                            <i class="fas fa-check-circle"></i>
                            <span>Fraud Protection</span>
                        </div>
                    </div>
                    
                    <button class="pay-button" onclick="processPayment('card')" id="cardPayButton">
                        <i class="fas fa-lock"></i>
                        <span>Pay Securely $<span id="cardPayAmount">0.00</span></span>
                    </button>
                </div>

                <!-- PayPal Payment Form -->
                <div class="payment-form" id="paypalPaymentForm">
                    <h4><i class="fab fa-paypal"></i> PayPal Payment</h4>
                    <div class="text-center mb-3">
                        <p>You will be securely redirected to PayPal to complete your payment.</p>
                        <p class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            You can use your PayPal balance, bank account, or any card linked to your PayPal account.
                        </p>
                    </div>
                    
                    <div class="security-badges">
                        <div class="security-badge">
                            <i class="fab fa-paypal"></i>
                            <span>PayPal Buyer Protection</span>
                        </div>
                        <div class="security-badge">
                            <i class="fas fa-shield-alt"></i>
                            <span>Secure Transaction</span>
                        </div>
                    </div>
                    
                    <button class="pay-button" onclick="processPayment('paypal')" id="paypalPayButton">
                        <i class="fab fa-paypal"></i>
                        <span>Pay with PayPal $<span id="paypalPayAmount">0.00</span></span>
                    </button>
                </div>

                <!-- Bank Transfer Payment Form -->
                <div class="payment-form" id="bankPaymentForm">
                    <h4><i class="fas fa-university"></i> Bank Transfer (ACH)</h4>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Bank transfers typically take 1-3 business days to process.</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="bankAccountType">Account Type *</label>
                        <select id="bankAccountType" class="form-control">
                            <option value="">Select Account Type</option>
                            <option value="checking">Checking</option>
                            <option value="savings">Savings</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="routingNumber">Routing Number *</label>
                        <input type="text" id="routingNumber" class="form-control" placeholder="123456789" maxlength="9" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="accountNumber">Account Number *</label>
                        <input type="password" id="accountNumber" class="form-control" placeholder="Account Number" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="accountHolderName">Account Holder Name *</label>
                        <input type="text" id="accountHolderName" class="form-control" placeholder="John Doe" autocomplete="name">
                    </div>
                    
                    <div class="security-badges">
                        <div class="security-badge">
                            <i class="fas fa-university"></i>
                            <span>Bank-level Security</span>
                        </div>
                        <div class="security-badge">
                            <i class="fas fa-lock"></i>
                            <span>Encrypted Transfer</span>
                        </div>
                    </div>
                    
                    <button class="pay-button" onclick="processPayment('bank')" id="bankPayButton">
                        <i class="fas fa-university"></i>
                        <span>Authorize Payment $<span id="bankPayAmount">0.00</span></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE: 'https://all-branched-end.onrender.com',
            STORAGE_KEYS: {
                AUTH_TOKEN: 'authToken',
                USER_DATA: 'userData'
            },
            VALIDATION: {
                CARD_NUMBER: {
                    MIN_LENGTH: 13,
                    MAX_LENGTH: 19
                },
                CVV: {
                    MIN_LENGTH: 3,
                    MAX_LENGTH: 4
                },
                ROUTING_NUMBER: {
                    LENGTH: 9
                },
                ZIP_CODE: {
                    MIN_LENGTH: 5
                }
            },
            MESSAGES: {
                SESSION_EXPIRED: 'Your session has expired. Please log in again.',
                PAYMENT_PROCESSING: 'Processing your payment...',
                PAYMENT_SUCCESS: 'Payment processed successfully!',
                PAYMENT_FAILED: 'Payment processing failed. Please try again.',
                DISCOUNT_APPLIED: 'Discount code applied successfully!',
                DISCOUNT_INVALID: 'Invalid or expired discount code.',
                FORM_VALIDATION_ERROR: 'Please fill in all required fields correctly.',
                NETWORK_ERROR: 'Network error. Please check your connection and try again.'
            }
        };

        // Application State
        const AppState = {
            currentInvoice: null,
            selectedPaymentMethod: null,
            appliedDiscount: null,
            isProcessingPayment: false,
            validationErrors: new Set()
        };

        // Utility Functions
        const Utils = {
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount);
            },

            formatDate: (dateString) => {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            },

            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            sanitizeInput: (input) => {
                return input.trim().replace(/[<>]/g, '');
            },

            isValidEmail: (email) => {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },

            generateTransactionId: () => {
                return 'txn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
        };

        // Alert Management
        const AlertManager = {
            container: null,

            init() {
                this.container = document.getElementById('statusAlerts');
            },

            show(type, message, autoHide = true) {
                if (!this.container) return;

                const alertId = 'alert-' + Date.now();
                const iconMap = {
                    success: 'fas fa-check-circle',
                    danger: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };

                const alertElement = document.createElement('div');
                alertElement.id = alertId;
                alertElement.className = `alert alert-${type}`;
                alertElement.innerHTML = `
                    <i class="${iconMap[type]}"></i>
                    <span>${message}</span>
                    <button type="button" class="alert-dismiss" onclick="AlertManager.dismiss('${alertId}')">
                        &times;
                    </button>
                `;

                this.container.appendChild(alertElement);

                // Auto-hide success messages
                if (autoHide && type === 'success') {
                    setTimeout(() => this.dismiss(alertId), 5000);
                }

                // Scroll to alert
                alertElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                return alertId;
            },

            dismiss(alertId) {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateX(100%)';
                    setTimeout(() => alert.remove(), 300);
                }
            },

            clearAll() {
                if (this.container) {
                    this.container.innerHTML = '';
                }
            }
        };

        // Session Management
        const SessionManager = {
            getToken() {
                return localStorage.getItem(CONFIG.STORAGE_KEYS.AUTH_TOKEN);
            },

            setToken(token) {
                localStorage.setItem(CONFIG.STORAGE_KEYS.AUTH_TOKEN, token);
            },

            removeToken() {
                localStorage.removeItem(CONFIG.STORAGE_KEYS.AUTH_TOKEN);
            },

            isValidSession() {
                const token = this.getToken();
                if (!token) return false;

                try {
                    // Basic JWT validation (you might want to add expiry check)
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.exp > Date.now() / 1000;
                } catch (error) {
                    return false;
                }
            },

            redirectToLogin() {
                AlertManager.show('warning', CONFIG.MESSAGES.SESSION_EXPIRED, false);
                setTimeout(() => {
                    window.location.replace('client-login.html');
                }, 2000);
            }
        };

        // API Service
        const ApiService = {
            async request(endpoint, options = {}) {
                const token = SessionManager.getToken();
                const defaultHeaders = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                };

                const config = {
                    headers: { ...defaultHeaders, ...options.headers },
                    ...options
                };

                try {
                    const response = await fetch(`${CONFIG.API_BASE}${endpoint}`, config);
                    
                    if (response.status === 401) {
                        SessionManager.redirectToLogin();
                        throw new Error('Unauthorized');
                    }

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `HTTP ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('API Request failed:', error);
                    if (error.message === 'Failed to fetch') {
                        throw new Error(CONFIG.MESSAGES.NETWORK_ERROR);
                    }
                    throw error;
                }
            },

            async getInvoice(invoiceId) {
                return this.request(`/invoice/${invoiceId}`);
            },

            async getProfile() {
                return this.request('/profile');
            },

            async validateDiscountCode(code, orderAmount) {
                return this.request('/validate-discount-code', {
                    method: 'POST',
                    body: JSON.stringify({
                        discountCode: code,
                        orderAmount: orderAmount
                    })
                });
            },

            async processPayment(paymentData) {
                return this.request('/process-payment', {
                    method: 'POST',
                    body: JSON.stringify(paymentData)
                });
            },

            async markDiscountUsed(discountId, paymentDetails) {
                return this.request('/mark-discount-used', {
                    method: 'POST',
                    body: JSON.stringify({
                        discountId: discountId,
                        paymentDetails: paymentDetails
                    })
                });
            },

            async getEligibleDiscounts() {
                return this.request('/my-discount-codes');
            }
        };

        // Form Validation
        const FormValidator = {
            errors: new Set(),

            validate(field, value, rules) {
                this.clearFieldErrors(field);
                const fieldElement = document.getElementById(field);
                
                for (const rule of rules) {
                    const error = rule(value);
                    if (error) {
                        this.addFieldError(field, error);
                        fieldElement?.classList.add('is-invalid');
                        return false;
                    }
                }
                
                fieldElement?.classList.remove('is-invalid');
                return true;
            },

            addFieldError(field, message) {
                this.errors.add(`${field}: ${message}`);
            },

            clearFieldErrors(field) {
                const toRemove = Array.from(this.errors).filter(error => error.startsWith(`${field}:`));
                toRemove.forEach(error => this.errors.delete(error));
            },

            clearAllErrors() {
                this.errors.clear();
                document.querySelectorAll('.is-invalid').forEach(el => {
                    el.classList.remove('is-invalid');
                });
            },

            getErrors() {
                return Array.from(this.errors);
            },

            hasErrors() {
                return this.errors.size > 0;
            }
        };

        // Validation Rules
        const ValidationRules = {
            required: (value) => !value || value.trim() === '' ? 'This field is required' : null,
            
            cardNumber: (value) => {
                const cleanValue = value.replace(/\s/g, '');
                if (cleanValue.length < CONFIG.VALIDATION.CARD_NUMBER.MIN_LENGTH || 
                    cleanValue.length > CONFIG.VALIDATION.CARD_NUMBER.MAX_LENGTH) {
                    return 'Please enter a valid card number';
                }
                // Basic Luhn algorithm check
                return ValidationRules.luhnCheck(cleanValue) ? null : 'Invalid card number';
            },

            luhnCheck: (cardNumber) => {
                let sum = 0;
                let alternate = false;
                for (let i = cardNumber.length - 1; i >= 0; i--) {
                    let n = parseInt(cardNumber.charAt(i), 10);
                    if (alternate) {
                        n *= 2;
                        if (n > 9) {
                            n = (n % 10) + 1;
                        }
                    }
                    sum += n;
                    alternate = !alternate;
                }
                return (sum % 10) === 0;
            },

            expiryDate: (value) => {
                const match = value.match(/^(0[1-9]|1[0-2])\/\d{2}$/);
                if (!match) return 'Please enter a valid expiry date (MM/YY)';
                
                const [month, year] = value.split('/');
                const expiry = new Date(2000 + parseInt(year), parseInt(month) - 1);
                const now = new Date();
                
                return expiry > now ? null : 'This card has expired';
            },

            cvv: (value) => {
                return value.length >= CONFIG.VALIDATION.CVV.MIN_LENGTH && 
                       value.length <= CONFIG.VALIDATION.CVV.MAX_LENGTH ? 
                       null : 'Please enter a valid CVV';
            },

            routingNumber: (value) => {
                return value.length === CONFIG.VALIDATION.ROUTING_NUMBER.LENGTH ? 
                       null : 'Please enter a valid 9-digit routing number';
            },

            zipCode: (value) => {
                return value.length >= CONFIG.VALIDATION.ZIP_CODE.MIN_LENGTH ? 
                       null : 'Please enter a valid ZIP code';
            },

            email: (value) => {
                return Utils.isValidEmail(value) ? null : 'Please enter a valid email address';
            }
        };

        // Input Formatters
        const InputFormatters = {
            init() {
                this.setupCardNumber();
                this.setupExpiryDate();
                this.setupNumericInputs();
            },

            setupCardNumber() {
                const cardNumberInput = document.getElementById('cardNumber');
                if (!cardNumberInput) return;

                cardNumberInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || '';
                    e.target.value = formattedValue;
                });

                cardNumberInput.addEventListener('blur', () => {
                    FormValidator.validate('cardNumber', cardNumberInput.value, [
                        ValidationRules.required,
                        ValidationRules.cardNumber
                    ]);
                });
            },

            setupExpiryDate() {
                const expiryInput = document.getElementById('expiryDate');
                if (!expiryInput) return;

                expiryInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });

                expiryInput.addEventListener('blur', () => {
                    FormValidator.validate('expiryDate', expiryInput.value, [
                        ValidationRules.required,
                        ValidationRules.expiryDate
                    ]);
                });
            },

            setupNumericInputs() {
                const numericInputs = ['cvv', 'routingNumber', 'accountNumber', 'billingZip'];
                
                numericInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (!input) return;

                    input.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/\D/g, '');
                    });

                    input.addEventListener('blur', () => {
                        this.validateNumericInput(inputId, input.value);
                    });
                });
            },

            validateNumericInput(inputId, value) {
                const rules = [ValidationRules.required];
                
                switch (inputId) {
                    case 'cvv':
                        rules.push(ValidationRules.cvv);
                        break;
                    case 'routingNumber':
                        rules.push(ValidationRules.routingNumber);
                        break;
                    case 'billingZip':
                        rules.push(ValidationRules.zipCode);
                        break;
                }

                FormValidator.validate(inputId, value, rules);
            }
        };

        // Invoice Manager
        const InvoiceManager = {
            async initialize() {
                const invoiceId = this.getInvoiceIdFromURL();
                
                if (invoiceId) {
                    await this.loadExistingInvoice(invoiceId);
                } else {
                    await this.createDraftInvoice();
                }
                
                await this.loadEligibleDiscounts();
            },

            getInvoiceIdFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            },

            async loadExistingInvoice(invoiceId) {
                try {
                    AppState.currentInvoice = await ApiService.getInvoice(invoiceId);
                    this.populateInvoiceData();
                } catch (error) {
                    AlertManager.show('danger', `Failed to load invoice: ${error.message}`);
                    console.error('Invoice loading error:', error);
                }
            },

            async createDraftInvoice() {
                try {
                    const profile = await ApiService.getProfile();
                    
                    AppState.currentInvoice = {
                        invoiceNumber: 'DRAFT-' + Date.now(),
                        date: new Date().toISOString().split('T')[0],
                        dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'pending',
                        client: profile,
                        services: [{
                            description: 'Professional Manuscript Editing',
                            quantity: 1,
                            rate: 250.00,
                            amount: 250.00
                        }],
                        subtotal: 250.00,
                        tax: 0.00,
                        total: 250.00
                    };

                    this.populateInvoiceData();
                } catch (error) {
                    AlertManager.show('danger', `Failed to create invoice: ${error.message}`);
                    console.error('Draft invoice creation error:', error);
                }
            },

            populateInvoiceData() {
                const invoice = AppState.currentInvoice;
                if (!invoice) return;

                // Invoice details
                this.updateElement('invoiceNumber', invoice.invoiceNumber);
                this.updateElement('invoiceDate', Utils.formatDate(invoice.date));
                this.updateElement('dueDate', Utils.formatDate(invoice.dueDate));
                this.updateInvoiceStatus(invoice.status);

                // Client information
                const clientName = invoice.client.fullName || 
                    `${invoice.client.firstName || ''} ${invoice.client.lastName || ''}`.trim();
                this.updateElement('clientName', clientName);
                this.updateElement('clientEmail', invoice.client.email);
                this.updateElement('clientInstitution', invoice.client.currentInstitution || 'N/A');

                // Service details
                this.populateServiceDetails(invoice);

                // Services table
                this.populateServicesTable(invoice.services);

                // Update totals
                this.updateTotals();
            },

            updateElement(id, content) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = content;
                }
            },

            updateInvoiceStatus(status) {
                const statusElement = document.getElementById('invoiceStatus');
                if (statusElement) {
                    statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    statusElement.className = `status-badge ${status}`;
                }
            },

            populateServiceDetails(invoice) {
                if (invoice.manuscript) {
                    this.updateElement('manuscriptTitle', invoice.manuscript.title || 'Professional Editing Service');
                    this.updateElement('serviceType', invoice.manuscript.serviceType || 'Standard Editing');
                    this.updateElement('wordCount', invoice.manuscript.wordCount || 'TBD');
                    this.updateElement('turnaround', invoice.manuscript.turnaround || '7-10 business days');
                } else {
                    this.updateElement('manuscriptTitle', 'Professional Editing Service');
                    this.updateElement('serviceType', 'Standard Editing');
                    this.updateElement('wordCount', 'TBD');
                    this.updateElement('turnaround', '7-10 business days');
                }
            },

            populateServicesTable(services) {
                const tbody = document.getElementById('servicesTableBody');
                if (!tbody) return;

                tbody.innerHTML = services.map(service => `
                    <tr>
                        <td>${Utils.sanitizeInput(service.description)}</td>
                        <td>${service.quantity}</td>
                        <td>${Utils.formatCurrency(service.rate)}</td>
                        <td>${Utils.formatCurrency(service.amount)}</td>
                    </tr>
                `).join('');
            },

            updateTotals() {
                const invoice = AppState.currentInvoice;
                if (!invoice) return;

                this.updateElement('subtotalAmount', Utils.formatCurrency(invoice.subtotal));
                
                const discountRow = document.getElementById('discountRow');
                if (invoice.discount) {
                    discountRow.style.display = 'flex';
                    this.updateElement('discountPercent', invoice.discount.discountPercentage);
                    this.updateElement('discountAmount', invoice.discount.discountAmount.toFixed(2));
                } else {
                    discountRow.style.display = 'none';
                }
                
                this.updateElement('taxAmount', Utils.formatCurrency(invoice.tax));
                this.updateElement('totalAmount', Utils.formatCurrency(invoice.total));
                
                // Update payment button amounts
                document.querySelectorAll('[id$="PayAmount"]').forEach(element => {
                    element.textContent = invoice.total.toFixed(2);
                });
            },

            async loadEligibleDiscounts() {
                try {
                    const codes = await ApiService.getEligibleDiscounts();
                    const activeCode = codes.find(code => 
                        !code.isUsed && new Date(code.expiresAt) > new Date()
                    );

                    if (activeCode) {
                        const discountInput = document.getElementById('discountCodeInput');
                        if (discountInput) {
                            discountInput.value = activeCode.code;
                            AlertManager.show('success', 
                                `You have an active ${activeCode.discountPercentage}% discount code! It has been automatically applied below.`
                            );
                        }
                    }
                } catch (error) {
                    console.error('Failed to load discount codes:', error);
                    // Don't show error to user as this is not critical
                }
            }
        };

        // Discount Manager
        const DiscountManager = {
            async apply() {
                const discountInput = document.getElementById('discountCodeInput');
                const discountCode = discountInput?.value.trim();
                
                if (!discountCode) {
                    AlertManager.show('warning', 'Please enter a discount code.');
                    return;
                }

                if (!AppState.currentInvoice) {
                    AlertManager.show('danger', 'Invoice data not loaded.');
                    return;
                }

                try {
                    const result = await ApiService.validateDiscountCode(
                        discountCode, 
                        AppState.currentInvoice.subtotal
                    );

                    if (result.valid) {
                        AppState.appliedDiscount = result;
                        AppState.currentInvoice.discount = result;
                        AppState.currentInvoice.total = result.finalAmount;
                        
                        InvoiceManager.updateTotals();
                        AlertManager.show('success', 
                            `Discount applied! You saved ${Utils.formatCurrency(result.discountAmount)} (${result.discountPercentage}%)`
                        );
                        
                        // Hide discount section after successful application
                        const discountSection = document.getElementById('discountSection');
                        if (discountSection) {
                            discountSection.style.display = 'none';
                        }
                    } else {
                        AlertManager.show('danger', result.error || CONFIG.MESSAGES.DISCOUNT_INVALID);
                    }
                } catch (error) {
                    AlertManager.show('danger', `Failed to apply discount: ${error.message}`);
                    console.error('Discount application error:', error);
                }
            }
        };

        // Payment Manager
        const PaymentManager = {
            selectMethod(method) {
                // Clear previous selections
                document.querySelectorAll('.payment-method').forEach(el => {
                    el.classList.remove('selected');
                });
                document.querySelectorAll('.payment-form').forEach(el => {
                    el.style.display = 'none';
                });

                // Select current method
                const methodElement = document.querySelector(`[data-method="${method}"]`);
                const formElement = document.getElementById(`${method}PaymentForm`);
                
                if (methodElement && formElement) {
                    methodElement.classList.add('selected');
                    formElement.style.display = 'block';
                    AppState.selectedPaymentMethod = method;
                    
                    // Clear any previous validation errors
                    FormValidator.clearAllErrors();
                }
            },

            async process(method) {
                if (!AppState.selectedPaymentMethod) {
                    AlertManager.show('warning', 'Please select a payment method.');
                    return;
                }

                if (AppState.isProcessingPayment) {
                    return; // Prevent double submission
                }

                // Validate form
                if (!this.validateForm(method)) {
                    return;
                }

                this.setProcessingState(true);

                try {
                    const paymentData = this.preparePaymentData(method);
                    const result = await ApiService.processPayment(paymentData);

                    if (result.success) {
                        // Mark discount as used if applicable
                        if (AppState.appliedDiscount?.discountId) {
                            await this.markDiscountAsUsed(result.transactionId, method);
                        }

                        // Redirect to success page
                        const successUrl = `payment-success.html?transaction=${result.transactionId}&invoice=${AppState.currentInvoice.invoiceNumber}`;
                        window.location.href = successUrl;
                    } else {
                        throw new Error(result.error || CONFIG.MESSAGES.PAYMENT_FAILED);
                    }

                } catch (error) {
                    AlertManager.show('danger', `Payment failed: ${error.message}`);
                    console.error('Payment processing error:', error);
                } finally {
                    this.setProcessingState(false);
                }
            },

            validateForm(method) {
                FormValidator.clearAllErrors();
                
                switch (method) {
                    case 'card':
                        return this.validateCardForm();
                    case 'paypal':
                        return true; // PayPal handles its own validation
                    case 'bank':
                        return this.validateBankForm();
                    default:
                        return false;
                }
            },

            validateCardForm() {
                const fields = [
                    { id: 'cardNumber', rules: [ValidationRules.required, ValidationRules.cardNumber] },
                    { id: 'expiryDate', rules: [ValidationRules.required, ValidationRules.expiryDate] },
                    { id: 'cvv', rules: [ValidationRules.required, ValidationRules.cvv] },
                    { id: 'cardName', rules: [ValidationRules.required] },
                    { id: 'billingZip', rules: [ValidationRules.required, ValidationRules.zipCode] }
                ];

                return this.validateFields(fields);
            },

            validateBankForm() {
                const fields = [
                    { id: 'bankAccountType', rules: [ValidationRules.required] },
                    { id: 'routingNumber', rules: [ValidationRules.required, ValidationRules.routingNumber] },
                    { id: 'accountNumber', rules: [ValidationRules.required] },
                    { id: 'accountHolderName', rules: [ValidationRules.required] }
                ];

                return this.validateFields(fields);
            },

            validateFields(fields) {
                let isValid = true;

                fields.forEach(({ id, rules }) => {
                    const element = document.getElementById(id);
                    if (element) {
                        const fieldValid = FormValidator.validate(id, element.value, rules);
                        if (!fieldValid) {
                            isValid = false;
                            if (!element.focused) {
                                element.focus();
                                element.focused = true;
                            }
                        }
                    }
                });

                if (!isValid) {
                    AlertManager.show('danger', CONFIG.MESSAGES.FORM_VALIDATION_ERROR);
                }

                return isValid;
            },

            preparePaymentData(method) {
                const baseData = {
                    invoiceId: AppState.currentInvoice.id || AppState.currentInvoice.invoiceNumber,
                    amount: AppState.currentInvoice.total,
                    method: method,
                    currency: 'USD',
                    discount: AppState.appliedDiscount,
                    transactionId: Utils.generateTransactionId()
                };

                switch (method) {
                    case 'card':
                        return {
                            ...baseData,
                            cardData: {
                                number: document.getElementById('cardNumber').value.replace(/\s/g, ''),
                                expiry: document.getElementById('expiryDate').value,
                                cvv: document.getElementById('cvv').value,
                                name: Utils.sanitizeInput(document.getElementById('cardName').value),
                                billingZip: document.getElementById('billingZip').value
                            }
                        };

                    case 'paypal':
                        return {
                            ...baseData,
                            redirectUrl: `${window.location.origin}/payment-success.html`
                        };

                    case 'bank':
                        return {
                            ...baseData,
                            bankData: {
                                accountType: document.getElementById('bankAccountType').value,
                                routingNumber: document.getElementById('routingNumber').value,
                                accountNumber: document.getElementById('accountNumber').value,
                                accountHolderName: Utils.sanitizeInput(document.getElementById('accountHolderName').value)
                            }
                        };

                    default:
                        throw new Error('Invalid payment method');
                }
            },

            async markDiscountAsUsed(transactionId, method) {
                try {
                    await ApiService.markDiscountUsed(AppState.appliedDiscount.discountId, {
                        transactionId: transactionId,
                        amount: AppState.currentInvoice.total,
                        method: method
                    });
                } catch (error) {
                    console.error('Failed to mark discount as used:', error);
                    // Don't throw error as payment was successful
                }
            },

            setProcessingState(isProcessing) {
                AppState.isProcessingPayment = isProcessing;
                
                const loadingSpinner = document.getElementById('loadingSpinner');
                const paymentSection = document.getElementById('paymentSection');
                const payButtons = document.querySelectorAll('.pay-button');

                if (loadingSpinner && paymentSection) {
                    if (isProcessing) {
                        loadingSpinner.style.display = 'block';
                        paymentSection.style.display = 'none';
                    } else {
                        loadingSpinner.style.display = 'none';
                        paymentSection.style.display = 'block';
                    }
                }

                payButtons.forEach(button => {
                    button.disabled = isProcessing;
                });
            }
        };

        // Application Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            // Check session validity
            if (!SessionManager.isValidSession()) {
                SessionManager.redirectToLogin();
                return;
            }

            // Initialize components
            AlertManager.init();
            InputFormatters.init();

            // Load invoice data
            try {
                await InvoiceManager.initialize();
            } catch (error) {
                AlertManager.show('danger', 'Failed to initialize invoice. Please refresh the page.');
                console.error('Initialization error:', error);
            }
        });

        // Global Functions (for onclick handlers)
        window.selectPaymentMethod = (method) => PaymentManager.selectMethod(method);
        window.processPayment = (method) => PaymentManager.process(method);
        window.applyDiscountCode = () => DiscountManager.apply();
        window.dismissAlert = (alertId) => AlertManager.dismiss(alertId);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            // Clear sensitive data
            AppState.currentInvoice = null;
            AppState.appliedDiscount = null;
        });