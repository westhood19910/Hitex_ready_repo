<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - HiTex EdiTex</title>
    <link rel="stylesheet" href="pricing.css">
    <link rel="stylesheet" href="clientdasnboard.css">
    <link rel="stylesheet" href="ser_them.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="fresh.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .success-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .success-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            animation: successPulse 2s ease-in-out infinite;
        }
        
        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .success-icon i {
            font-size: 3rem;
            color: white;
        }
        
        .success-title {
            font-size: 2.5rem;
            color: #2c5aa0;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .success-message {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .transaction-details {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: left;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c5aa0;
        }
        
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        
        .detail-value {
            color: #333;
            font-weight: 600;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #d4edda;
            color: #155724;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }
        
        .action-btn {
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2c5aa0 0%, #3d6bb3 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            color: white;
            text-decoration: none;
        }
        
        .next-steps {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }
        
        .next-steps h3 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .steps-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .steps-list li {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .steps-list li:last-child {
            border-bottom: none;
        }
        
        .step-number {
            background: rgba(255,255,255,0.2);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .step-text {
            line-height: 1.5;
        }
        
        .contact-support {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .contact-support h4 {
            color: #2c5aa0;
            margin-bottom: 1rem;
        }
        
        .support-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .support-item {
            text-align: center;
        }
        
        .support-item i {
            font-size: 1.5rem;
            color: #2c5aa0;
            margin-bottom: 0.5rem;
        }
        
        .loading-animation {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-state {
            text-align: center;
            color: #dc3545;
            padding: 2rem;
        }
        
        .error-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .success-container {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .success-title {
                font-size: 2rem;
            }
            
            .success-message {
                font-size: 1.1rem;
            }
            
            .transaction-details {
                padding: 1.5rem;
            }
            
            .detail-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .support-info {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <nav class="nav__bar_oi">
        <div class="nav__bar_oi-logo">
            <a href="index.html"><img src="assets/png_20221026_003820_0000.png" alt="HiTex EdiTex Logo"></a>
        </div>
        <div class="nav__bar_oi-utility">
            <div class="nav__bar_oi-actions">
                <a href="client-dashboard.html" class="nav__bar_oi-button">Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="success-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-animation">
            <div>
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: #666;">Verifying payment...</p>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <h2>Payment Verification Error</h2>
            <p id="errorMessage">Unable to verify payment. Please contact support.</p>
            <div class="action-buttons">
                <a href="client-dashboard.html" class="action-btn btn-primary">
                    <i class="fas fa-home"></i> Go to Dashboard
                </a>
                <button onclick="retryVerification()" class="action-btn btn-secondary">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        </div>

        <!-- Success State -->
        <div id="successState" style="display: none;">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            
            <h1 class="success-title">Payment Successful!</h1>
            <p class="success-message">
                Thank you for your payment. Your transaction has been processed successfully and you will receive a confirmation email shortly.
            </p>

            <!-- Transaction Details -->
            <div class="transaction-details">
                <h3 style="margin-bottom: 1.5rem; color: #2c5aa0;">
                    <i class="fas fa-receipt"></i> Transaction Details
                </h3>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">
                        <span class="status-badge">
                            <i class="fas fa-check-circle"></i>
                            <span id="paymentStatus">Completed</span>
                        </span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Amount Paid:</span>
                    <span class="detail-value" id="amountPaid">Loading...</span>
                </div>
            </div>

            <!-- Next Steps -->
            <div class="next-steps">
                <h3><i class="fas fa-list-check"></i> What Happens Next?</h3>
                <ul class="steps-list">
                    <li>
                        <span class="step-number">1</span>
                        <div class="step-text">
                            <strong>Confirmation Email:</strong> You'll receive a detailed receipt via email within 5 minutes.
                        </div>
                    </li>
                    <li>
                        <span class="step-number">2</span>
                        <div class="step-text">
                            <strong>Editor Assignment:</strong> Your manuscript will be assigned to a qualified editor within 24 hours.
                        </div>
                    </li>
                    <li>
                        <span class="step-number">3</span>
                        <div class="step-text">
                            <strong>Progress Updates:</strong> You'll receive regular updates on your manuscript's editing progress.
                        </div>
                    </li>
                    <li>
                        <span class="step-number">4</span>
                        <div class="step-text">
                            <strong>Delivery:</strong> Your edited manuscript will be delivered according to the agreed timeline.
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="client-dashboard.html" class="action-btn btn-primary">
                    <i class="fas fa-tachometer-alt"></i> Go to Dashboard
                </a>
                <button onclick="downloadReceipt()" class="action-btn btn-secondary">
                    <i class="fas fa-download"></i> Download Receipt
                </button>
                <button onclick="viewInvoice()" class="action-btn btn-success">
                    <i class="fas fa-file-invoice"></i> View Invoice
                </button>
            </div>

            <!-- Contact Support -->
            <div class="contact-support">
                <h4><i class="fas fa-headset"></i> Need Help?</h4>
                <p>Our support team is here to assist you with any questions about your payment or editing service.</p>
                <div class="support-info">
                    <div class="support-item">
                        <i class="fas fa-envelope"></i>
                        <div>
                            <strong>Email</strong><br>
                            <a href="mailto:support@hitexeditex.com">support@hitexeditex.com</a>
                        </div>
                    </div>
                    <div class="support-item">
                        <i class="fas fa-comments"></i>
                        <div>
                            <strong>Live Chat</strong><br>
                            Available 24/7
                        </div>
                    </div>
                    <div class="support-item">
                        <i class="fas fa-clock"></i>
                        <div>
                            <strong>Response Time</strong><br>
                            Within 1 hour
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const API_BASE = 'https://all-branched-end.onrender.com';
        let transactionData = null;
        let invoiceData = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            if (!validateSession()) return;
            
            const urlParams = new URLSearchParams(window.location.search);
            const transactionId = urlParams.get('transaction');
            const invoiceNumber = urlParams.get('invoice');
            
            if (transactionId && invoiceNumber) {
                await loadPaymentDetails(transactionId, invoiceNumber);
            } else {
                showError('Missing transaction information. Please check your email for payment confirmation.');
            }
        });

        // Session validation
        function validateSession() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.replace('client-login.html');
                return false;
            }
            return true;
        }

        // Load payment and transaction details
        async function loadPaymentDetails(transactionId, invoiceNumber) {
            try {
                const token = localStorage.getItem('authToken');
                
                // Load transaction details
                const transactionResponse = await fetch(`${API_BASE}/transaction/${transactionId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!transactionResponse.ok) {
                    throw new Error('Failed to load transaction details');
                }

                const transactionDetails = await transactionResponse.json();
                transactionData = transactionDetails;
                
                // Load invoice details
                const invoiceResponse = await fetch(`${API_BASE}/invoice/${invoiceNumber}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!invoiceResponse.ok) {
                    throw new Error('Failed to load invoice details');
                }

                invoiceData = await invoiceResponse.json();
                
                // Populate the success page
                populateSuccessPage(transactionDetails, invoiceData);
                
                // Show success state
                showSuccessState();
                
                // Update dashboard in background
                updateDashboardInBackground();
                
            } catch (error) {
                console.error('Error loading payment details:', error);
                showError(`Failed to load payment details: ${error.message}`);
            }
        }

        // Populate success page with data
        function populateSuccessPage(transaction, invoice) {
            // Transaction details
            document.getElementById('transactionId').textContent = transaction.transaction.transactionId;
            document.getElementById('invoiceNumber').textContent = invoice.invoiceNumber;
            document.getElementById('paymentMethod').textContent = formatPaymentMethod(transaction.payment.method);
            document.getElementById('paymentDate').textContent = formatDateTime(transaction.payment.createdAt);
            document.getElementById('paymentStatus').textContent = formatStatus(transaction.payment.status);
            document.getElementById('amountPaid').textContent = `${transaction.payment.amount.toFixed(2)} ${transaction.payment.currency}`;

            // Update status badge color based on payment status
            const statusBadge = document.querySelector('.status-badge');
            if (transaction.payment.status === 'pending') {
                statusBadge.style.background = '#fff3cd';
                statusBadge.style.color = '#856404';
                statusBadge.querySelector('i').className = 'fas fa-clock';
            }
        }

        // Show success state
        function showSuccessState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('successState').style.display = 'block';
        }

        // Show error state
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // Retry verification
        async function retryVerification() {
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
            
            const urlParams = new URLSearchParams(window.location.search);
            const transactionId = urlParams.get('transaction');
            const invoiceNumber = urlParams.get('invoice');
            
            if (transactionId && invoiceNumber) {
                await loadPaymentDetails(transactionId, invoiceNumber);
            } else {
                setTimeout(() => {
                    showError('Missing transaction information in URL.');
                }, 1000);
            }
        }

        // Download receipt
        async function downloadReceipt() {
            if (!transactionData) {
                alert('Transaction data not available');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/download-receipt/${transactionData.transaction.transactionId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `Receipt_${transactionData.transaction.transactionId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    // Fallback: generate receipt in browser
                    generateBrowserReceipt();
                }
            } catch (error) {
                console.error('Error downloading receipt:', error);
                // Fallback: generate receipt in browser
                generateBrowserReceipt();
            }
        }

        // Generate receipt in browser (fallback)
        function generateBrowserReceipt() {
            const receiptWindow = window.open('', '_blank');
            const receiptHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Payment Receipt - ${transactionData.transaction.transactionId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #2c5aa0; padding-bottom: 20px; }
                        .details { margin: 20px 0; }
                        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
                        .total { font-weight: bold; font-size: 1.2em; color: #2c5aa0; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>HiTex EdiTex</h1>
                        <h2>Payment Receipt</h2>
                    </div>
                    <div class="details">
                        <div class="detail-row">
                            <span>Transaction ID:</span>
                            <span>${transactionData.transaction.transactionId}</span>
                        </div>
                        <div class="detail-row">
                            <span>Invoice Number:</span>
                            <span>${invoiceData.invoiceNumber}</span>
                        </div>
                        <div class="detail-row">
                            <span>Date:</span>
                            <span>${formatDateTime(transactionData.payment.createdAt)}</span>
                        </div>
                        <div class="detail-row">
                            <span>Payment Method:</span>
                            <span>${formatPaymentMethod(transactionData.payment.method)}</span>
                        </div>
                        <div class="detail-row total">
                            <span>Amount Paid:</span>
                            <span>${transactionData.payment.amount.toFixed(2)} ${transactionData.payment.currency}</span>
                        </div>
                    </div>
                    <div class="no-print" style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()">Print Receipt</button>
                        <button onclick="window.close()">Close</button>
                    </div>
                </body>
                </html>
            `;
            receiptWindow.document.write(receiptHTML);
            receiptWindow.document.close();
        }

        // View invoice
        function viewInvoice() {
            if (invoiceData) {
                window.open(`invoice.html?id=${invoiceData.invoiceNumber}`, '_blank');
            } else {
                alert('Invoice data not available');
            }
        }

        // Update dashboard in background
        async function updateDashboardInBackground() {
            try {
                const token = localStorage.getItem('authToken');
                
                // Refresh user's manuscript data
                await fetch(`${API_BASE}/my-manuscripts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Refresh dashboard summary
                await fetch(`${API_BASE}/dashboard-summary`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('Dashboard data refreshed in background');
                
            } catch (error) {
                console.error('Failed to refresh dashboard data:', error);
            }
        }

        // Format payment method for display
        function formatPaymentMethod(method) {
            const methods = {
                'card': 'Credit/Debit Card',
                'paypal': 'PayPal',
                'bank': 'Bank Transfer'
            };
            return methods[method] || method.charAt(0).toUpperCase() + method.slice(1);
        }

        // Format status for display
        function formatStatus(status) {
            return status.charAt(0).toUpperCase() + status.slice(1);
        }

        // Format date and time
        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });
        }

        // Make functions available globally
        window.retryVerification = retryVerification;
        window.downloadReceipt = downloadReceipt;
        window.viewInvoice = viewInvoice;
    </script>
</body>