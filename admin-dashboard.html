<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        :root {
            --red: #D54C4F;
            --blue: #032672;
            --light-blue: #D3E5FF;
            --button-background: linear-gradient(135deg, #eb2525, #af1e1e);
            --white: #ffffff;
            --text-color: #333;
            --grey-light: #f7f9fc;
            --grey: #e5e9f2;
            --text: #2c3e50;
            --text-light: #7e8c9a;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius: 10px;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--grey-light); color: var(--text-color); margin: 0; padding: 2em; }
        .adm-fiu-dashboard-container { max-width: 1200px; margin: auto; background-color: var(--white); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        h1 { color: var(--blue); border-bottom: 2px solid var(--light-blue); padding-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; table-layout: fixed; }
        th, td { border: 1px solid var(--grey); padding: 12px; text-align: left; vertical-align: middle; word-wrap: break-word; }
        th { background-color: var(--light-blue); color: var(--blue); font-weight: bold; }
        .adm-fiu-download-btn { display: inline-block; padding: 6px 12px; background: var(--blue); color: white; text-decoration: none; border-radius: 4px; }
        .assign-btn { padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        select, .assign-btn { font-size: 0.9rem; padding: 4px; }
        .adm-fiu-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 100; }
        .adm-fiu-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--white); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-hover); z-index: 101; width: 90%; max-width: 600px; }
        .adm-fiu-modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--grey); padding-bottom: 1rem; margin-bottom: 1rem; }
        .adm-fiu-modal-header h2 { margin: 0; color: var(--blue); }
        .adm-fiu-modal-close { background: none; border: none; font-size: 2rem; cursor: pointer; }
        .adm-fiu-modal-body .form-row { display: flex; gap: 1rem; }
        .adm-fiu-modal-body .form-group { flex: 1; margin-bottom: 1rem; }
        .adm-fiu-modal-body label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-light); }
        .adm-fiu-modal-body input, .adm-fiu-modal-body select { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--grey); box-sizing: border-box; }
        .adm-fiu-submit-assignment { width: 100%; padding: 0.8rem; border: none; border-radius: var(--radius); background: var(--button-background); color: var(--white); font-size: 1.1rem; cursor: pointer; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="adm-fiu-dashboard-container">
        <h1>Manuscript Submissions</h1>
        <table id="manuscriptTable">
            <thead>
                <tr>
                    <th style="width: 15%;">Submission Date</th>
                    <th style="width: 25%;">Original Filename</th>
                    <th style="width: 20%;">Status</th>
                    <th style="width: 10%;">Download</th>
                    <th style="width: 30%;">Assign to Editor</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div class="adm-fiu-modal-overlay" id="assignmentModalOverlay" style="display: none;"></div>
    <div class="adm-fiu-modal" id="assignmentModal" style="display: none;">
        <div class="adm-fiu-modal-header">
            <h2>Assign Job Details</h2>
            <button class="adm-fiu-modal-close" id="closeModalBtn">&times;</button>
        </div>
        <div class="adm-fiu-modal-body">
            <form id="assignmentDetailsForm">
                <input type="hidden" id="modalManuscriptId">
                <input type="hidden" id="modalEditorId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Job Code:</label>
                        <input type="text" id="modalJobCode" placeholder="e.g., EDIT-001">
                    </div>
                    <div class="form-group">
                        <label>Job Type:</label>
                        <input type="text" id="modalJobType" value="Original">
                    </div>
                </div>
                <div class="form-group">
                    <label>Service Type:</label>
                    <select id="modalServiceType">
                        <option value="proofreading">Proofreading</option>
                        <option value="copy-editing">Copy-editing</option>
                        <option value="substantive-editing">Substantive Editing</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Editable Words:</label><input type="number" id="modalEditableWords"></div>
                    <div class="form-group"><label>Effective Editable Words:</label><input type="number" id="modalEffectiveWords"></div>
                </div>
                <div class="form-group"><label>Target Journal:</label><input type="text" id="modalTargetJournal"></div>
                <div class="form-group"><label>English Language Requirements:</label><select id="modalLanguage"><option value="American English">American English</option><option value="British English">British English</option></select></div>
                <div class="form-group"><label>Subject Area:</label><input type="text" id="modalSubjectArea"></div>
                <div class="form-row">
                    <div class="form-group"><label>Begin by (Deadline):</label><input type="datetime-local" id="modalStartDate"></div>
                    <div class="form-group"><label>Return by (Deadline):</label><input type="datetime-local" id="modalReturnDate"></div>
                </div>
                <button type="submit" class="adm-fiu-submit-assignment">Finalize Assignment</button>
            </form>
        </div>
    </div>

    <script>
        // --- These functions are in the global scope so the 'onclick' attribute can find them ---
        function openAssignmentModal(manuscriptId, wordCount, serviceType) {
            const editorId = document.getElementById(`editor-select-${manuscriptId}`).value;
            if (!editorId) {
                alert('Please select an editor from the dropdown.');
                return;
            }
            // Store IDs and pre-fill data in the modal's form
            document.getElementById('modalManuscriptId').value = manuscriptId;
            document.getElementById('modalEditorId').value = editorId;
            document.getElementById('modalEditableWords').value = wordCount;
            document.getElementById('modalEffectiveWords').value = wordCount;
            document.getElementById('modalServiceType').value = serviceType; // Set the dropdown value
            
            // Show the modal
            document.getElementById('assignmentModal').style.display = 'block';
            document.getElementById('assignmentModalOverlay').style.display = 'block';
        }

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'none';
            document.getElementById('assignmentModalOverlay').style.display = 'none';
        }

        // --- The main script that runs after the page is loaded ---
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('adminAuthToken');
            if (!token) {
                alert('Admin access required. Please log in.');
                window.location.href = '/admin-login.html';
                return;
            }

            // Attach event listeners for the modal buttons
            document.getElementById('closeModalBtn').addEventListener('click', closeAssignmentModal);
            document.getElementById('assignmentModalOverlay').addEventListener('click', closeAssignmentModal);
            
            // Event listener for the final assignment from the modal form
            document.getElementById('assignmentDetailsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const manuscriptId = document.getElementById('modalManuscriptId').value;
                const assignmentData = {
                    editorId: document.getElementById('modalEditorId').value,
                    jobCode: document.getElementById('modalJobCode').value,
                    jobType: document.getElementById('modalJobType').value,
                    serviceType: document.getElementById('modalServiceType').value,
                    editableWords: document.getElementById('modalEditableWords').value,
                    effectiveEditableWords: document.getElementById('modalEffectiveWords').value,
                    targetJournal: document.getElementById('modalTargetJournal').value,
                    languageRequirements: document.getElementById('modalLanguage').value,
                    subjectArea: document.getElementById('modalSubjectArea').value,
                    assignmentStartDate: document.getElementById('modalStartDate').value,
                    assignmentReturnDate: document.getElementById('modalReturnDate').value
                };

                try {
                    const response = await fetch(`https://hitex-backend-server.onrender.com/admin/assign-job/${manuscriptId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(assignmentData)
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    alert('Job assigned successfully!');
                    window.location.reload();
                } catch (error) {
                    alert('Failed to assign job: ' + error.message);
                }
            });

            // Logic to fetch data and build the table
            try {
                const editorResponse = await fetch('https://hitex-backend-server.onrender.com/admin/editors', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!editorResponse.ok) throw new Error('Could not fetch editors.');
                const editors = await editorResponse.json();

                const manuscriptResponse = await fetch('https://hitex-backend-server.onrender.com/admin/dashboard', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!manuscriptResponse.ok) throw new Error('Could not fetch manuscripts.');
                const manuscripts = await manuscriptResponse.json();

                const tableBody = document.querySelector('#manuscriptTable tbody');
                tableBody.innerHTML = ''; 

                manuscripts.forEach(doc => {
                    const row = tableBody.insertRow();
                    let statusInfo = doc.status || 'New';
                    if (doc.assignedEditorId) {
                        const assignedEditor = editors.find(e => e._id === doc.assignedEditorId);
                        statusInfo = `<span style="color: green; font-weight: bold;">Assigned</span> (to: ${assignedEditor ? assignedEditor.fullName : 'Unknown'})`;
                    }
                    let editorOptions = '<option value="">Select an Editor...</option>';
                    editors.forEach(editor => {
                        editorOptions += `<option value="${editor._id}">${editor.fullName}</option>`;
                    });
                    row.innerHTML = `
                        <td>${new Date(doc.uploadDate).toLocaleString()}</td>
                        <td>${doc.originalName}</td>
                        <td>${statusInfo}</td>
                        <td><a href="https://hitex-backend-server.onrender.com/${doc.filePath}" class="adm-fiu-download-btn" download>Download</a></td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                               <select id="editor-select-${doc._id}" style="flex-grow: 1;">${editorOptions}</select>
                               <button onclick="openAssignmentModal('${doc._id}', '${doc.wordCount}', '${doc.serviceType}')" class="assign-btn">Assign</button>
                            </div>
                        </td>
                    `;
                });
            } catch (error) {
                alert('Error loading dashboard: ' + error.message);
            }
        });
    </script>
</body>
</html>