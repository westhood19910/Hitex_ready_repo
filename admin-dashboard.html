<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - HiTex EdiTex</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #032672;
            --primary-light: #D3E5FF;
            --accent: #eb2525;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --white: #ffffff;
            --grey-light: #f7f9fc;
            --grey: #e5e9f2;
            --text: #2c3e50;
            --text-light: #7e8c9a;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--grey-light);
            color: var(--text);
        }

        /* Header */
        .admin-header {
            background: var(--primary);
            color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-warning { background: var(--warning); color: var(--text); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-info { background: var(--info); color: var(--white); }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }

        .btn:hover { filter: brightness(110%); transform: translateY(-2px); }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: calc(100vh - 64px);
        }

        /* Sidebar */
        .admin-sidebar {
            width: 260px;
            background: var(--white);
            box-shadow: var(--shadow);
            padding: 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            color: var(--text-light);
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            padding: 0 1.5rem;
            margin-bottom: 0.5rem;
        }

        .nav-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text);
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--grey-light);
            border-left-color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary-light);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .admin-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--white);
        }

        .stat-icon.primary { background: var(--primary); }
        .stat-icon.success { background: var(--success); }
        .stat-icon.warning { background: var(--warning); }
        .stat-icon.danger { background: var(--danger); }

        .stat-info h3 {
            font-size: 2rem;
            margin-bottom: 0.25rem;
        }

        .stat-info p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Panel */
        .panel {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .panel-body {
            padding: 1.5rem;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--grey);
        }

        .data-table th {
            background: var(--grey-light);
            font-weight: 600;
            color: var(--primary);
        }

        .data-table tbody tr:hover {
            background: var(--grey-light);
        }

        /* Status Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-new { background: #e3f2fd; color: #1976d2; }
        .badge-assigned { background: #fff3e0; color: #f57c00; }
        .badge-completed { background: #e8f5e9; color: #388e3c; }
        .badge-paid { background: #e8f5e9; color: #388e3c; }
        .badge-unpaid { background: #ffebee; color: #c62828; }
        .badge-pending { background: #fff3e0; color: #f57c00; }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--grey);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Search & Filters */
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-bar input,
        .search-bar select {
            flex: 1;
            min-width: 200px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--grey);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--grey);
            background: var(--white);
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-sidebar {
                width: 200px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            border: 3px solid var(--grey);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #81c784;
        }

        .alert-danger {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #e57373;
        }

        .alert-warning {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffb74d;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <h1><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
        <div class="admin-user">
            <span id="adminName">Administrator</span>
            <button class="btn btn-danger btn-sm" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Content Management</div>
                <div class="nav-item" onclick="showSection('manuscripts')">
                    <i class="fas fa-file-alt"></i>
                    <span>Manuscripts</span>
                </div>
                <div class="nav-item" onclick="showSection('editors')">
                    <i class="fas fa-user-edit"></i>
                    <span>Editors</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">User Management</div>
                <div class="nav-item" onclick="showSection('users')">
                    <i class="fas fa-users"></i>
                    <span>All Users</span>
                </div>
                <div class="nav-item" onclick="showSection('guest-requests')">
                    <i class="fas fa-user-clock"></i>
                    <span>Guest Requests</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Financial</div>
                <div class="nav-item" onclick="showSection('invoices')">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Invoices</span>
                </div>
                <div class="nav-item" onclick="showSection('payments')">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Discounts</div>
                <div class="nav-item" onclick="showSection('institutions')">
                    <i class="fas fa-university"></i>
                    <span>Partner Institutions</span>
                </div>
                <div class="nav-item" onclick="showSection('discount-codes')">
                    <i class="fas fa-tags"></i>
                    <span>Discount Codes</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Security</div>
                <div class="nav-item" onclick="showSection('password-resets')">
                    <i class="fas fa-key"></i>
                    <span>Password Resets</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Analytics</div>
                <div class="nav-item" onclick="showSection('analytics')">
                    <i class="fas fa-chart-line"></i>
                    <span>Reports</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <h2 style="margin-bottom: 1.5rem;">Dashboard Overview</h2>
                
                <div class="stats-grid" id="dashboardStats">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalManuscripts">0</h3>
                            <p>Total Manuscripts</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalRevenue">$0</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="unpaidInvoices">0</h3>
                            <p>Unpaid Invoices</p>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h2>Recent Activity</h2>
                        <button class="btn btn-primary btn-sm" onclick="loadDashboardData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="panel-body">
                        <div id="recentActivity">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Manuscripts Section -->
            <section id="manuscripts" class="content-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>Manuscripts</h2>
                        <button class="btn btn-primary btn-sm" onclick="loadManuscripts()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="search-bar">
                            <input type="text" class="form-control" placeholder="Search manuscripts..." id="manuscriptSearch">
                            <select class="form-control" id="manuscriptStatusFilter">
                                <option value="">All Statuses</option>
                                <option value="New">New</option>
                                <option value="Assigned">Assigned</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                            <button class="btn btn-primary" onclick="filterManuscripts()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>

                        <table class="data-table" id="manuscriptsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Filename</th>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Editor</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users" class="content-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>User Management</h2>
                        <button class="btn btn-primary btn-sm" onclick="loadUsers()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="search-bar">
                            <input type="text" class="form-control" placeholder="Search by email..." id="userSearch">
                            <input type="text" class="form-control" placeholder="Search by institution..." id="institutionSearch">
                            <select class="form-control" id="userTypeFilter">
                                <option value="">All Users</option>
                                <option value="true">Institutional</option>
                                <option value="false">Regular</option>
                            </select>
                            <button class="btn btn-primary" onclick="searchUsers()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>

                        <div id="bulkActions" style="display: none; margin-bottom: 1rem;">
                            <span id="selectedCount">0 users selected</span>
                            <button class="btn btn-danger btn-sm" onclick="bulkDeleteUsers()">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                        </div>

                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllUsers" onchange="toggleSelectAll()"></th>
                                    <th>Email</th>
                                    <th>Name</th>
                                    <th>Institution</th>
                                    <th>Type</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                        <div id="usersPagination" class="pagination"></div>
                    </div>
                </div>
            </section>

            <!-- Guest Requests Section -->
            <section id="guest-requests" class="content-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>Guest Quote Requests</h2>
                        <button class="btn btn-primary btn-sm" onclick="loadGuestRequests()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="stats-grid" style="margin-bottom: 1.5rem;">
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="totalGuestRequests">0</h3>
                                    <p>Total Requests</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="completedGuestRequests">0</h3>
                                    <p>Completed</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="conversionRate">0%</h3>
                                    <p>Conversion Rate</p>
                                </div>
                            </div>
                        </div>

                        <table class="data-table" id="guestRequestsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Email</th>
                                    <th>Name</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Invoices Section -->
            <section id="invoices" class="content-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>Invoices</h2>
                        <button class="btn btn-primary btn-sm" onclick="loadInvoices()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="search-bar">
                            <select class="form-control" id="invoiceStatusFilter">
                                <option value="">All Statuses</option>
                                <option value="paid">Paid</option>
                                <option value="unpaid">Unpaid</option>
                                <option value="pending">Pending</option>
                            </select>
                            <button class="btn btn-primary" onclick="filterInvoices()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>

                        <table class="data-table" id="invoicesTable">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Payments Section -->
            <section id="payments" class="content-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>Payment Analytics</h2>
                        <button class="btn btn-primary btn-sm" onclick="loadPaymentAnalytics()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="stats-grid" id="paymentStats"></div>
                        <div id="paymentCharts"></div>
                    </div>
                </div>
            </section>

            <!-- Partner Institutions Section -->
            <section id="institutions" class="content-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>Partner Institutions</h2>
                        <button class="btn btn-success btn-sm" onclick="showAddInstitutionModal()">
                            <i class="fas fa-plus"></i> Add Institution
                        </button>
                    </div>
                    <div class="panel-body">
                        <table class="data-table" id="institutionsTable">
                            <thead>
                                <tr>
                                    <th>Institution</th>
                                    <th>Domains</th>
                                    <th>Discount %</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Password Resets Section -->
            <section id="password-resets" class="content-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>Password Reset Requests</h2>
                        <button class="btn btn-primary btn-sm" onclick="loadPasswordResets()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="stats-grid" style="margin-bottom: 1.5rem;">
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="totalResetRequests">0</h3>
                                    <p>Total Requests</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="activeTokens">0</h3>
                                    <p>Active Tokens</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="resetSuccessRate">0%</h3>
                                    <p>Success Rate</p>
                                </div>
                            </div>
                        </div>

                        <table class="data-table" id="passwordResetsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Email</th>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Expires</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2>Analytics & Reports</h2>
                        <div>
                            <button class="btn btn-info btn-sm" onclick="exportReport('users')">
                                <i class="fas fa-download"></i> Export Users
                            </button>
                            <button class="btn btn-info btn-sm" onclick="exportReport('payments')">
                                <i class="fas fa-download"></i> Export Payments
                            </button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div id="analyticsContent">
                            <p>Select report type and date range to generate analytics...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Assignment Modal -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assign Manuscript to Editor</h2>
                <button class="close-modal" onclick="closeModal('assignmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="assignmentForm">
                    <input type="hidden" id="modalManuscriptId">
                    
                    <div class="form-group">
                        <label>Select Editor *</label>
                        <select class="form-control" id="modalEditorSelect" required></select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Job Code</label>
                            <input type="text" class="form-control" id="modalJobCode">
                        </div>
                        <div class="form-group">
                            <label>Job Type</label>
                            <input type="text" class="form-control" id="modalJobType" value="Original">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Service Type</label>
                        <select class="form-control" id="modalServiceType">
                            <option value="proofreading">Proofreading</option>
                            <option value="copy-editing">Copy-editing</option>
                            <option value="substantive-editing">Substantive Editing</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Editable Words</label>
                            <input type="number" class="form-control" id="modalEditableWords">
                        </div>
                        <div class="form-group">
                            <label>Effective Words</label>
                            <input type="number" class="form-control" id="modalEffectiveWords">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Target Journal</label>
                        <input type="text" class="form-control" id="modalTargetJournal">
                    </div>

                    <div class="form-group">
                        <label>Language Requirements</label>
                        <select class="form-control" id="modalLanguage">
                            <option value="American English">American English</option>
                            <option value="British English">British English</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Subject Area</label>
                        <input type="text" class="form-control" id="modalSubjectArea">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Begin Date</label>
                            <input type="datetime-local" class="form-control" id="modalStartDate">
                        </div>
                        <div class="form-group">
                            <label>Return Date</label>
                            <input type="datetime-local" class="form-control" id="modalReturnDate">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('assignmentModal')">Cancel</button>
                <button class="btn btn-success" onclick="submitAssignment()">Assign Job</button>
            </div>
        </div>
    </div>

    <!-- Add Institution Modal -->
    <div id="addInstitutionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Partner Institution</h2>
                <button class="close-modal" onclick="closeModal('addInstitutionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="institutionForm">
                    <div class="form-group">
                        <label>Institution Name *</label>
                        <input type="text" class="form-control" id="institutionName" required>
                    </div>

                    <div class="form-group">
                        <label>Institution Code</label>
                        <input type="text" class="form-control" id="institutionCode">
                    </div>

                    <div class="form-group">
                        <label>Email Domains (comma separated) *</label>
                        <input type="text" class="form-control" id="emailDomains" placeholder="university.edu, college.edu" required>
                    </div>

                    <div class="form-group">
                        <label>Discount Percentage *</label>
                        <input type="number" class="form-control" id="discountPercentage" min="1" max="50" required>
                    </div>

                    <div class="form-group">
                        <label>Contact Email</label>
                        <input type="email" class="form-control" id="contactEmail">
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea class="form-control" id="institutionNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addInstitutionModal')">Cancel</button>
                <button class="btn btn-success" onclick="submitInstitution()">Add Institution</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
                <button class="close-modal" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Warning!</strong> This action cannot be undone.
                </div>
                <p id="deleteMessage"></p>
                <div id="deleteUsersList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeletion()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://all-branched-end.onrender.com';
        let currentData = {
            manuscripts: [],
            users: [],
            invoices: [],
            editors: [],
            guestRequests: [],
            institutions: [],
            passwordResets: []
        };
        let selectedUsers = new Set();
        let deleteCallback = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadDashboardData();
        });

        function checkAuth() {
            const token = localStorage.getItem('adminAuthToken');
            if (!token) {
                window.location.href = 'admin-login.html';
                return;
            }
        }

        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${localStorage.getItem('adminAuthToken')}`,
                'Content-Type': 'application/json'
            };
        }

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            // Load data for section
            switch(sectionId) {
                case 'dashboard': loadDashboardData(); break;
                case 'manuscripts': loadManuscripts(); break;
                case 'users': loadUsers(); break;
                case 'guest-requests': loadGuestRequests(); break;
                case 'invoices': loadInvoices(); break;
                case 'payments': loadPaymentAnalytics(); break;
                case 'institutions': loadInstitutions(); break;
                case 'password-resets': loadPasswordResets(); break;
            }
        }

        // Dashboard
        async function loadDashboardData() {
            try {
                const [manuscripts, users, analytics] = await Promise.all([
                    fetch(`${API_BASE}/admin/dashboard`, { headers: getAuthHeaders() }).then(r => r.json()),
                    fetch(`${API_BASE}/admin/all-users?limit=1000`, { headers: getAuthHeaders() }).then(r => r.json()),
                    fetch(`${API_BASE}/admin/payment-analytics`, { headers: getAuthHeaders() }).then(r => r.json())
                ]);

                document.getElementById('totalManuscripts').textContent = manuscripts.length;
                document.getElementById('totalUsers').textContent = users.pagination.totalUsers;
                document.getElementById('totalRevenue').textContent = `${analytics.summary.totalRevenue.toFixed(2)}`;
                
                const unpaid = manuscripts.filter(m => !m.paid).length;
                document.getElementById('unpaidInvoices').textContent = unpaid;

                displayRecentActivity(manuscripts.slice(0, 10));
            } catch (error) {
                console.error('Dashboard error:', error);
                showAlert('Failed to load dashboard data', 'danger');
            }
        }

        function displayRecentActivity(manuscripts) {
            const container = document.getElementById('recentActivity');
            if (manuscripts.length === 0) {
                container.innerHTML = '<p>No recent activity</p>';
                return;
            }

            container.innerHTML = manuscripts.map(m => `
                <div style="padding: 0.75rem; border-bottom: 1px solid var(--grey);">
                    <strong>${m.originalName}</strong> - ${m.status}
                    <br><small>${new Date(m.uploadDate).toLocaleString()}</small>
                </div>
            `).join('');
        }

        // Manuscripts
        async function loadManuscripts() {
            showLoading('manuscriptsTable');
            try {
                const [manuscripts, editors] = await Promise.all([
                    fetch(`${API_BASE}/admin/dashboard`, { headers: getAuthHeaders() }).then(r => r.json()),
                    fetch(`${API_BASE}/admin/editors`, { headers: getAuthHeaders() }).then(r => r.json())
                ]);

                currentData.manuscripts = manuscripts;
                currentData.editors = editors;
                displayManuscripts(manuscripts);
            } catch (error) {
                console.error('Manuscripts error:', error);
                showAlert('Failed to load manuscripts', 'danger');
            }
        }

        function displayManuscripts(manuscripts) {
            const tbody = document.querySelector('#manuscriptsTable tbody');
            tbody.innerHTML = '';

            if (manuscripts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No manuscripts found</td></tr>';
                return;
            }

            manuscripts.forEach(m => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(m.uploadDate).toLocaleDateString()}</td>
                    <td>${m.originalName}</td>
                    <td>${m.submitterInfo?.email || 'N/A'}</td>
                    <td><span class="badge badge-${m.status.toLowerCase().replace(' ', '-')}">${m.status}</span></td>
                    <td>${m.assignedEditorId ? getEditorName(m.assignedEditorId) : 'Unassigned'}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="downloadManuscript('${m._id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        ${!m.assignedEditorId ? `
                            <button class="btn btn-success btn-sm" onclick="showAssignmentModal('${m._id}')">
                                <i class="fas fa-user-plus"></i> Assign
                            </button>
                        ` : ''}
                    </td>
                `;
            });
        }

        function getEditorName(editorId) {
            const editor = currentData.editors.find(e => e._id === editorId);
            return editor ? editor.fullName : 'Unknown';
        }

        async function showAssignmentModal(manuscriptId) {
            const manuscript = currentData.manuscripts.find(m => m._id === manuscriptId);
            if (!manuscript) return;

            document.getElementById('modalManuscriptId').value = manuscriptId;
            
            const select = document.getElementById('modalEditorSelect');
            select.innerHTML = '<option value="">Select Editor...</option>';
            currentData.editors.forEach(e => {
                select.innerHTML += `<option value="${e._id}">${e.fullName}</option>`;
            });

            if (manuscript.wordCount) {
                document.getElementById('modalEditableWords').value = manuscript.wordCount;
                document.getElementById('modalEffectiveWords').value = manuscript.wordCount;
            }

            openModal('assignmentModal');
        }

        async function submitAssignment() {
            const manuscriptId = document.getElementById('modalManuscriptId').value;
            const editorId = document.getElementById('modalEditorSelect').value;

            if (!editorId) {
                showAlert('Please select an editor', 'warning');
                return;
            }

            const data = {
                editorId,
                jobCode: document.getElementById('modalJobCode').value,
                jobType: document.getElementById('modalJobType').value,
                serviceType: document.getElementById('modalServiceType').value,
                editableWords: document.getElementById('modalEditableWords').value,
                effectiveEditableWords: document.getElementById('modalEffectiveWords').value,
                targetJournal: document.getElementById('modalTargetJournal').value,
                languageRequirements: document.getElementById('modalLanguage').value,
                subjectArea: document.getElementById('modalSubjectArea').value,
                assignmentStartDate: document.getElementById('modalStartDate').value,
                assignmentReturnDate: document.getElementById('modalReturnDate').value
            };

            try {
                const response = await fetch(`${API_BASE}/admin/assign-job/${manuscriptId}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('Job assigned successfully!', 'success');
                    closeModal('assignmentModal');
                    loadManuscripts();
                } else {
                    throw new Error('Assignment failed');
                }
            } catch (error) {
                showAlert('Failed to assign job', 'danger');
            }
        }

        // Users
        async function loadUsers(page = 1) {
            showLoading('usersTable');
            try {
                const response = await fetch(`${API_BASE}/admin/all-users?page=${page}&limit=20`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                currentData.users = data.users;
                displayUsers(data.users);
                displayPagination(data.pagination);
            } catch (error) {
                console.error('Users error:', error);
                showAlert('Failed to load users', 'danger');
            }
        }

        function displayUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No users found</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="checkbox" class="user-checkbox" value="${user.email}" onchange="updateSelectedUsers()"></td>
                    <td>${user.email}</td>
                    <td>${user.fullName || user.firstName + ' ' + user.lastName}</td>
                    <td>${user.currentInstitution || 'N/A'}</td>
                    <td>${user.isInstitutionalUser ? 'Institutional' : 'Regular'}</td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.email}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        function updateSelectedUsers() {
            selectedUsers.clear();
            document.querySelectorAll('.user-checkbox:checked').forEach(cb => {
                selectedUsers.add(cb.value);
            });

            const bulkActions = document.getElementById('bulkActions');
            const count = document.getElementById('selectedCount');
            
            if (selectedUsers.size > 0) {
                bulkActions.style.display = 'block';
                count.textContent = `${selectedUsers.size} users selected`;
            } else {
                bulkActions.style.display = 'none';
            }
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAllUsers').checked;
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = checked);
            updateSelectedUsers();
        }

        async function deleteUser(email) {
            showDeleteConfirmation(
                `Are you sure you want to delete user: ${email}?`,
                [email],
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/admin/delete-user-by-email`, {
                            method: 'DELETE',
                            headers: getAuthHeaders(),
                            body: JSON.stringify({ email })
                        });

                        if (response.ok) {
                            showAlert('User deleted successfully', 'success');
                            loadUsers();
                        } else {
                            throw new Error('Delete failed');
                        }
                    } catch (error) {
                        showAlert('Failed to delete user', 'danger');
                    }
                }
            );
        }

        async function bulkDeleteUsers() {
            if (selectedUsers.size === 0) return;

            showDeleteConfirmation(
                `Delete ${selectedUsers.size} selected users?`,
                Array.from(selectedUsers),
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/admin/delete-multiple-users`, {
                            method: 'DELETE',
                            headers: getAuthHeaders(),
                            body: JSON.stringify({ emails: Array.from(selectedUsers) })
                        });

                        if (response.ok) {
                            showAlert('Users deleted successfully', 'success');
                            selectedUsers.clear();
                            loadUsers();
                        } else {
                            throw new Error('Bulk delete failed');
                        }
                    } catch (error) {
                        showAlert('Failed to delete users', 'danger');
                    }
                }
            );
        }

        async function searchUsers() {
            const email = document.getElementById('userSearch').value;
            const institution = document.getElementById('institutionSearch').value;
            const type = document.getElementById('userTypeFilter').value;

            let url = `${API_BASE}/admin/search-users?limit=100`;
            if (email) url += `&email=${encodeURIComponent(email)}`;
            if (institution) url += `&institution=${encodeURIComponent(institution)}`;
            if (type) url += `&isInstitutional=${type}`;

            try {
                const response = await fetch(url, { headers: getAuthHeaders() });
                const data = await response.json();
                displayUsers(data.users);
            } catch (error) {
                showAlert('Search failed', 'danger');
            }
        }

        // Guest Requests
        async function loadGuestRequests() {
            try {
                const [requests, analytics] = await Promise.all([
                    fetch(`${API_BASE}/admin/guest-requests`, { headers: getAuthHeaders() }).then(r => r.json()),
                    fetch(`${API_BASE}/admin/guest-request-analytics`, { headers: getAuthHeaders() }).then(r => r.json())
                ]);

                currentData.guestRequests = requests.guestRequests;
                displayGuestRequests(requests.guestRequests);
                
                document.getElementById('totalGuestRequests').textContent = analytics.totalRequests;
                document.getElementById('completedGuestRequests').textContent = analytics.completedRequests;
                document.getElementById('conversionRate').textContent = analytics.conversionRate.toFixed(1) + '%';
            } catch (error) {
                console.error('Guest requests error:', error);
                showAlert('Failed to load guest requests', 'danger');
            }
        }

        function displayGuestRequests(requests) {
            const tbody = document.querySelector('#guestRequestsTable tbody');
            tbody.innerHTML = '';

            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No guest requests found</td></tr>';
                return;
            }

            requests.forEach(req => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(req.createdAt).toLocaleDateString()}</td>
                    <td>${req.submitterInfo.email}</td>
                    <td>${req.submitterInfo.firstName} ${req.submitterInfo.lastName}</td>
                    <td>${req.quoteDetails.serviceType}</td>
                    <td><span class="badge badge-${req.status}">${req.status}</span></td>
                    <td>
                        ${req.status === 'pending_signup' ? `
                            <button class="btn btn-success btn-sm" onclick="convertGuestRequest('${req._id}')">
                                <i class="fas fa-user-check"></i> Convert
                            </button>
                        ` : ''}
                    </td>
                `;
            });
        }

        // Invoices
        async function loadInvoices() {
            try {
                const response = await fetch(`${API_BASE}/admin/invoices?limit=50`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                currentData.invoices = data.invoices;
                displayInvoices(data.invoices);
            } catch (error) {
                console.error('Invoices error:', error);
                showAlert('Failed to load invoices', 'danger');
            }
        }

        function displayInvoices(invoices) {
            const tbody = document.querySelector('#invoicesTable tbody');
            tbody.innerHTML = '';

            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No invoices found</td></tr>';
                return;
            }

            invoices.forEach(inv => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${inv.invoiceNumber}</td>
                    <td>${new Date(inv.issueDate).toLocaleDateString()}</td>
                    <td>${inv.client.fullName}</td>
                    <td>${inv.total.toFixed(2)}</td>
                    <td><span class="badge badge-${inv.paymentStatus}">${inv.paymentStatus}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewInvoice('${inv._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
            });
        }

        // Payment Analytics
        async function loadPaymentAnalytics() {
            try {
                const analytics = await fetch(`${API_BASE}/admin/payment-analytics`, {
                    headers: getAuthHeaders()
                }).then(r => r.json());

                const statsHTML = `
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>${analytics.summary.totalRevenue.toFixed(2)}</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>${analytics.summary.totalPayments}</h3>
                            <p>Total Payments</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>${analytics.summary.avgPaymentAmount.toFixed(2)}</h3>
                            <p>Avg Payment</p>
                        </div>
                    </div>
                `;

                document.getElementById('paymentStats').innerHTML = statsHTML;
            } catch (error) {
                console.error('Payment analytics error:', error);
                showAlert('Failed to load payment analytics', 'danger');
            }
        }

        // Institutions
        async function loadInstitutions() {
            try {
                const response = await fetch(`${API_BASE}/admin/partner-institutions`, {
                    headers: getAuthHeaders()
                });
                const institutions = await response.json();
                currentData.institutions = institutions;
                displayInstitutions(institutions);
            } catch (error) {
                console.error('Institutions error:', error);
                showAlert('Failed to load institutions', 'danger');
            }
        }

        function displayInstitutions(institutions) {
            const tbody = document.querySelector('#institutionsTable tbody');
            tbody.innerHTML = '';

            if (institutions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No institutions found</td></tr>';
                return;
            }

            institutions.forEach(inst => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${inst.institutionName}</td>
                    <td>${inst.emailDomains.join(', ')}</td>
                    <td>${inst.discountPercentage}%</td>
                    <td><span class="badge badge-${inst.isActive ? 'completed' : 'new'}">${inst.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="toggleInstitutionStatus('${inst._id}', ${inst.isActive})">
                            ${inst.isActive ? 'Deactivate' : 'Activate'}
                        </button>
                    </td>
                `;
            });
        }

        function showAddInstitutionModal() {
            document.getElementById('institutionForm').reset();
            openModal('addInstitutionModal');
        }

        async function submitInstitution() {
            const data = {
                institutionName: document.getElementById('institutionName').value,
                institutionCode: document.getElementById('institutionCode').value,
                emailDomains: document.getElementById('emailDomains').value.split(',').map(d => d.trim()),
                discountPercentage: parseInt(document.getElementById('discountPercentage').value),
                contactEmail: document.getElementById('contactEmail').value,
                notes: document.getElementById('institutionNotes').value
            };

            try {
                const response = await fetch(`${API_BASE}/admin/partner-institutions`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('Institution added successfully', 'success');
                    closeModal('addInstitutionModal');
                    loadInstitutions();
                } else {
                    throw new Error('Failed to add institution');
                }
            } catch (error) {
                showAlert('Failed to add institution', 'danger');
            }
        }

        async function toggleInstitutionStatus(id, currentStatus) {
            try {
                const response = await fetch(`${API_BASE}/admin/partner-institutions/${id}/deactivate`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showAlert('Institution status updated', 'success');
                    loadInstitutions();
                } else {
                    throw new Error('Update failed');
                }
            } catch (error) {
                showAlert('Failed to update institution', 'danger');
            }
        }

        // Password Resets
        async function loadPasswordResets() {
            try {
                const [resets, analytics] = await Promise.all([
                    fetch(`${API_BASE}/admin/password-resets?limit=50`, { headers: getAuthHeaders() }).then(r => r.json()),
                    fetch(`${API_BASE}/admin/password-reset-analytics`, { headers: getAuthHeaders() }).then(r => r.json())
                ]);

                currentData.passwordResets = resets.resetRequests;
                displayPasswordResets(resets.resetRequests);
                
                document.getElementById('totalResetRequests').textContent = analytics.summary.totalRequests;
                document.getElementById('activeTokens').textContent = analytics.summary.activeTokens;
                document.getElementById('resetSuccessRate').textContent = analytics.summary.successRate + '%';
            } catch (error) {
                console.error('Password resets error:', error);
                showAlert('Failed to load password resets', 'danger');
            }
        }

        function displayPasswordResets(resets) {
            const tbody = document.querySelector('#passwordResetsTable tbody');
            tbody.innerHTML = '';

            if (resets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No password reset requests</td></tr>';
                return;
            }

            resets.forEach(reset => {
                const row = tbody.insertRow();
                const status = reset.used ? 'Used' : (new Date(reset.expiresAt) < new Date() ? 'Expired' : 'Active');
                row.innerHTML = `
                    <td>${new Date(reset.createdAt).toLocaleDateString()}</td>
                    <td>${reset.email}</td>
                    <td>${reset.user ? reset.user.fullName : 'N/A'}</td>
                    <td><span class="badge badge-${status.toLowerCase()}">${status}</span></td>
                    <td>${new Date(reset.expiresAt).toLocaleString()}</td>
                    <td>
                        ${status === 'Active' ? `
                            <button class="btn btn-danger btn-sm" onclick="expireToken('${reset._id}')">
                                <i class="fas fa-ban"></i> Expire
                            </button>
                        ` : ''}
                    </td>
                `;
            });
        }

        // Utility Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showLoading(tableId) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="10"><div class="loading"><div class="spinner"></div></div></td></tr>';
            }
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '80px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10000';
            alertDiv.style.minWidth = '300px';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 4000);
        }

        function showDeleteConfirmation(message, items, callback) {
            document.getElementById('deleteMessage').textContent = message;
            const list = document.getElementById('deleteUsersList');
            list.innerHTML = '<ul>' + items.map(item => `<li>${item}</li>`).join('') + '</ul>';
            deleteCallback = callback;
            openModal('deleteModal');
        }

        async function confirmDeletion() {
            if (deleteCallback) {
                await deleteCallback();
                deleteCallback = null;
            }
            closeModal('deleteModal');
        }

        function displayPagination(pagination) {
            const container = document.getElementById('usersPagination');
            if (!container) return;
            
            container.innerHTML = '';

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = !pagination.hasPrev;
            prevBtn.onclick = () => loadUsers(pagination.currentPage - 1);
            container.appendChild(prevBtn);

            // Page numbers
            for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === pagination.currentPage ? 'active' : '';
                pageBtn.onclick = () => loadUsers(i);
                container.appendChild(pageBtn);
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.disabled = !pagination.hasNext;
            nextBtn.onclick = () => loadUsers(pagination.currentPage + 1);
            container.appendChild(nextBtn);
        }

        async function downloadManuscript(id) {
            try {
                const response = await fetch(`${API_BASE}/download/${id}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'manuscript.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    showAlert('Download failed', 'danger');
                }
            } catch (error) {
                showAlert('Download error', 'danger');
            }
        }

        function filterManuscripts() {
            const status = document.getElementById('manuscriptStatusFilter').value;
            const search = document.getElementById('manuscriptSearch').value.toLowerCase();
            
            let filtered = currentData.manuscripts;
            
            if (status) {
                filtered = filtered.filter(m => m.status === status);
            }
            
            if (search) {
                filtered = filtered.filter(m => 
                    m.originalName.toLowerCase().includes(search) ||
                    (m.submitterInfo?.email || '').toLowerCase().includes(search)
                );
            }
            
            displayManuscripts(filtered);
        }

        function filterInvoices() {
            const status = document.getElementById('invoiceStatusFilter').value;
            let filtered = currentData.invoices;
            
            if (status) {
                filtered = filtered.filter(inv => inv.paymentStatus === status);
            }
            
            displayInvoices(filtered);
        }

        async function viewInvoice(id) {
            window.open(`invoice.html?id=${id}`, '_blank');
        }

        async function convertGuestRequest(id) {
            const password = prompt('Enter a temporary password for the new user account:');
            if (!password || password.length < 8) {
                showAlert('Password must be at least 8 characters', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/convert-guest-request/${id}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    showAlert('Guest request converted successfully', 'success');
                    loadGuestRequests();
                } else {
                    throw new Error('Conversion failed');
                }
            } catch (error) {
                showAlert('Failed to convert guest request', 'danger');
            }
        }

        async function expireToken(tokenId) {
            if (!confirm('Are you sure you want to expire this password reset token?')) return;

            try {
                const response = await fetch(`${API_BASE}/admin/password-reset/${tokenId}/expire`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showAlert('Token expired successfully', 'success');
                    loadPasswordResets();
                } else {
                    throw new Error('Failed to expire token');
                }
            } catch (error) {
                showAlert('Failed to expire token', 'danger');
            }
        }

        function exportReport(type) {
            showAlert(`Exporting ${type} report...`, 'info');
            // Implementation for CSV export
            let data, filename, headers;
            
            switch(type) {
                case 'users':
                    data = currentData.users;
                    filename = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
                    headers = ['Email', 'Name', 'Institution', 'Type', 'Created'];
                    break;
                case 'payments':
                    data = currentData.invoices;
                    filename = `payments_export_${new Date().toISOString().split('T')[0]}.csv`;
                    headers = ['Invoice #', 'Date', 'Client', 'Amount', 'Status'];
                    break;
                default:
                    return;
            }
            
            const csvContent = [
                headers.join(','),
                ...data.map(item => {
                    if (type === 'users') {
                        return [
                            item.email,
                            `"${item.fullName || item.firstName + ' ' + item.lastName}"`,
                            `"${item.currentInstitution || 'N/A'}"`,
                            item.isInstitutionalUser ? 'Institutional' : 'Regular',
                            new Date(item.createdAt).toLocaleDateString()
                        ].join(',');
                    } else {
                        return [
                            item.invoiceNumber,
                            new Date(item.issueDate).toLocaleDateString(),
                            `"${item.client.fullName}"`,
                            item.total.toFixed(2),
                            item.paymentStatus
                        ].join(',');
                    }
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('Report exported successfully', 'success');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminAuthToken');
                window.location.href = 'admin-login.html';
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        console.log('Comprehensive Admin Dashboard Initialized');
    </script>
</body>
</html>