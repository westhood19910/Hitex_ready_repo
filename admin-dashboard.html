<!DOCTYPE html>
<html lang="en">
<head> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<script src="Embednav.js" defer></script>
<script src="freshtex.js" defer></script> 
<link rel="stylesheet" href="ser_them.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" defer>
<link rel="stylesheet" href="fresh.css">  
<link rel="stylesheet" href="Embednav.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head> 

<body>
<nav class="nav__bar_oi">
  <div class="nav__bar_oi-logo">
    <a href="index.html"><img src="assets/png_20221026_003820_0000.png" alt="HiTex EdiTex Logo"></a>
  </div>
  
  <button class="nav__bar_oi-toggle" id="navToggle">
    <span class="nav__bar_oi-toggle-line"></span>
    <span class="nav__bar_oi-toggle-line"></span>
    <span class="nav__bar_oi-toggle-line"></span>
  </button>
  
  <ul class="nav__bar_oi-menu" id="navMenu">
    <li class="nav__bar_oi-menu-item">
      <a href="about.html" class="nav__bar_oi-menu-link">About Us</a>
    </li>
    <li class="nav__bar_oi-menu-item">
      <a href="#services" class="nav__bar_oi-menu-link">Services</a>
      <div class="nav__bar_oi-dropdown">
        <a href="language-editng.html" class="nav__bar_oi-dropdown-item">Language Editing</a>
        <a href="Scientific.html" class="nav__bar_oi-dropdown-item">Scientific Editing</a>
        <a href="technichal.html" class="nav__bar_oi-dropdown-item">Technical Editing</a>
        <a href="translate.html" class="nav__bar_oi-dropdown-item">Translation Services</a>
        <a href="service-levels.html" class="nav__bar_oi-dropdown-item">Service Levels</a>
        <a href="pricing.html" class="nav__bar_oi-dropdown-item">Pricing</a>
      </div>
    </li>
    <li class="nav__bar_oi-menu-item">
      <a href="#careers" class="nav__bar_oi-menu-link">Careers</a>
      <div class="nav__bar_oi-dropdown">
        <a href="life-at-hitex.html" class="nav__bar_oi-dropdown-item">Life at HiTex EdiTex</a>
        <a href="In-house.html" class="nav__bar_oi-dropdown-item">In-house</a>
        <a href="freelance.html" class="nav__bar_oi-dropdown-item">Freelance</a>
      </div>
    </li>
    <li class="nav__bar_oi-menu-item">
      <a href="contact.html" class="nav__bar_oi-menu-link">Contact Us</a>
    </li>
    <li class="nav__bar_oi-menu-item">
      <a href="#resources" class="nav__bar_oi-menu-link">Helpful Resources</a>
      <div class="nav__bar_oi-dropdown">
        <a href="support" class="nav__bar_oi-dropdown-item">Support and FAQs</a>
        <a href="hitex-hub.html" class="nav__bar_oi-dropdown-item">The Hitex Hub</a>
      </div>
    </li>
    <div class="nav__bar_oi-actions">
      <button class="nav__bar_oi-button nav__bar_oi-button-signup">Client Sign-Up</button>
      <button class="nav__bar_oi-button nav__bar_oi-button-login">Client Log-in</button>
    </div>
  </ul>
</nav>

<style>
:root {
    --blue: #032672;
    --light-blue: #D3E5FF;
    --button-background: linear-gradient(135deg, #eb2525, #af1e1e);
    --white: #ffffff;
    --text-color: #333;
    --grey-light: #f7f9fc;
    --grey: #e5e9f2;
    --text-light: #7e8c9a;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
    --radius: 10px;
    --danger: #dc3545;
    --warning: #ffc107;
    --success: #28a745;
}

.adm-fiu-dashboard-container { 
    max-width: 1200px; 
    margin: 6rem auto; 
    background-color: var(--white); 
    padding: 2rem; 
    border-radius: var(--radius); 
    box-shadow: var(--shadow); 
}

.dashboard-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--grey);
}

.tab-button {
    padding: 0.8rem 1.5rem;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    color: var(--text-light);
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}

.tab-button.active {
    color: var(--blue);
    border-bottom-color: var(--blue);
    font-weight: bold;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

h1 { 
    color: var(--blue); 
    border-bottom: 2px solid var(--light-blue); 
    padding-bottom: 0.5rem;
}

table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 1.5rem; 
    table-layout: fixed;
}

th, td { 
    border: 1px solid var(--grey); 
    padding: 12px; 
    text-align: left; 
    vertical-align: middle; 
    word-wrap: break-word; 
}

th { 
    background-color: var(--light-blue); 
    color: var(--blue); 
    font-weight: bold; 
}

.adm-fiu-download-btn { 
    display: inline-block; 
    padding: 6px 12px; 
    background: var(--blue); 
    color: white; 
    text-decoration: none; 
    border-radius: 4px; 
}

.assign-btn { 
    padding: 5px 10px; 
    background-color: var(--success); 
    color: white; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
}

.delete-btn {
    padding: 5px 10px;
    background-color: var(--danger);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 5px;
}

.delete-btn:hover {
    background-color: #c82333;
}

.search-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    align-items: center;
}

.search-input, .search-select {
    padding: 0.5rem;
    border: 1px solid var(--grey);
    border-radius: 4px;
    min-width: 150px;
}

.search-btn, .clear-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    color: white;
}

.search-btn {
    background-color: var(--blue);
}

.clear-btn {
    background-color: var(--text-light);
}

.bulk-actions {
    margin-bottom: 1rem;
    padding: 1rem;
    background-color: var(--grey-light);
    border-radius: var(--radius);
    display: none;
}

.bulk-delete-btn {
    padding: 0.5rem 1rem;
    background-color: var(--danger);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.user-checkbox {
    transform: scale(1.2);
}

select, .assign-btn { 
    font-size: 0.9rem; 
    padding: 4px; 
}

.adm-fiu-modal-overlay { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(0, 0, 0, 0.6); 
    z-index: 100; 
}

.adm-fiu-modal { 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    background: var(--white); 
    padding: 1.5rem; 
    border-radius: var(--radius); 
    z-index: 101; 
    width: 90%; 
    max-width: 600px; 
}

.adm-fiu-modal-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-bottom: 1px solid var(--grey); 
    padding-bottom: 1rem; 
    margin-bottom: 1rem; 
}

.adm-fiu-modal-header h2 { 
    margin: 0; 
    color: var(--blue);
}

.adm-fiu-modal-close { 
    background: none; 
    border: none; 
    font-size: 2rem; 
    cursor: pointer; 
}

.adm-fiu-modal-body .form-row { 
    display: flex; 
    gap: 1rem; 
}

.adm-fiu-modal-body .form-group { 
    flex: 1; 
    margin-bottom: 1rem; 
}

.adm-fiu-modal-body label { 
    display: block; 
    margin-bottom: 0.5rem; 
    font-weight: bold; 
}

.adm-fiu-modal-body input, .adm-fiu-modal-body select { 
    width: 100%; 
    padding: 0.5rem; 
    border-radius: 4px; 
    border: 1px solid var(--grey); 
    box-sizing: border-box; 
}

.adm-fiu-submit-assignment { 
    width: 100%; 
    padding: 0.8rem; 
    border: none; 
    border-radius: var(--radius); 
    background: var(--button-background); 
    color: var(--white); 
    font-size: 1.1rem; 
    cursor: pointer; 
    margin-top: 1rem; 
}

.confirmation-text {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 1rem;
    border-radius: 4px;
    margin: 1rem 0;
}

.danger-text {
    color: var(--danger);
    font-weight: bold;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
}

.pagination button {
    padding: 0.5rem 1rem;
    border: 1px solid var(--grey);
    background: white;
    cursor: pointer;
    border-radius: 4px;
}

.pagination button.active {
    background: var(--blue);
    color: white;
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>

<div class="adm-fiu-dashboard-container">
    <h1>Admin Dashboard</h1>
    
    <!-- Tab Navigation -->
    <div class="dashboard-tabs">
        <button class="tab-button active" onclick="switchTab('manuscripts')">Manuscripts</button>
        <button class="tab-button" onclick="switchTab('users')">User Management</button>
    </div>

    <!-- Manuscripts Tab -->
    <div id="manuscripts-tab" class="tab-content active">
        <h2>Submissions</h2>
        <table id="manuscriptTable">
            <thead>
                <tr>
                    <th style="width: 15%;">Submission Date</th>
                    <th style="width: 25%;">Original Filename</th>
                    <th style="width: 20%;">Status</th>
                    <th style="width: 10%;">Download</th>
                    <th style="width: 30%;">Assign to Editor</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
        <h2>User Management</h2>
        
        <!-- Search Controls -->
        <div class="search-controls">
            <input type="text" id="userSearchEmail" class="search-input" placeholder="Search by email...">
            <input type="text" id="userSearchInstitution" class="search-input" placeholder="Search by institution...">
            <select id="userSearchInstitutional" class="search-select">
                <option value="">All Users</option>
                <option value="true">Institutional Users</option>
                <option value="false">Non-Institutional Users</option>
            </select>
            <input type="date" id="userSearchDateFrom" class="search-input">
            <input type="date" id="userSearchDateTo" class="search-input">
            <button onclick="searchUsers()" class="search-btn">Search</button>
            <button onclick="clearUserSearch()" class="clear-btn">Clear</button>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="bulk-actions">
            <span id="selectedCount">0 users selected</span>
            <button onclick="showBulkDeleteConfirmation()" class="bulk-delete-btn">Delete Selected Users</button>
        </div>

        <!-- Users Table -->
        <table id="usersTable">
            <thead>
                <tr>
                    <th style="width: 5%;"><input type="checkbox" id="selectAllUsers" onchange="toggleSelectAll()"></th>
                    <th style="width: 25%;">Email</th>
                    <th style="width: 20%;">Full Name</th>
                    <th style="width: 20%;">Institution</th>
                    <th style="width: 15%;">Created Date</th>
                    <th style="width: 10%;">Type</th>
                    <th style="width: 5%;">Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <!-- Pagination -->
        <div id="usersPagination" class="pagination"></div>
    </div>
</div>

<!-- Assignment Modal (existing) -->
<div class="adm-fiu-modal-overlay" id="assignmentModalOverlay" style="display: none;"></div>
<div class="adm-fiu-modal" id="assignmentModal" style="display: none;">
    <div class="adm-fiu-modal-header">
        <h2>Assign Job Details</h2>
        <button class="adm-fiu-modal-close" id="closeModalBtn">&times;</button>
    </div>
    <div class="adm-fiu-modal-body">
        <form id="assignmentDetailsForm">
            <input type="hidden" id="modalManuscriptId">
            <input type="hidden" id="modalEditorId">
            <div class="form-row">
                <div class="form-group"><label>Job Code:</label><input type="text" id="modalJobCode" placeholder="e.g., EDIT-001"></div>
                <div class="form-group"><label>Job Type:</label><input type="text" id="modalJobType" value="Original"></div>
            </div>
            <div class="form-group">
                <label>Service Type:</label>
                <select id="modalServiceType">
                    <option value="proofreading">Proofreading</option>
                    <option value="copy-editing">Copy-editing</option>
                    <option value="substantive-editing">Substantive Editing</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Editable Words:</label><input type="number" id="modalEditableWords"></div>
                <div class="form-group"><label>Effective Editable Words:</label><input type="number" id="modalEffectiveWords"></div>
            </div>
            <div class="form-group"><label>Target Journal:</label><input type="text" id="modalTargetJournal"></div>
            <div class="form-group"><label>English Language Requirements:</label><select id="modalLanguage"><option value="American English">American English</option><option value="British English">British English</option></select></div>
            <div class="form-group"><label>Subject Area:</label><input type="text" id="modalSubjectArea"></div>
            <div class="form-row">
                <div class="form-group"><label>Begin by (Deadline):</label><input type="datetime-local" id="modalStartDate"></div>
                <div class="form-group"><label>Return by (Deadline):</label><input type="datetime-local" id="modalReturnDate"></div>
            </div>
            <button type="submit" class="adm-fiu-submit-assignment">Finalize Assignment</button>
        </form>
    </div>
</div>

<!-- User Deletion Confirmation Modal -->
<div class="adm-fiu-modal-overlay" id="deleteModalOverlay" style="display: none;"></div>
<div class="adm-fiu-modal" id="deleteModal" style="display: none;">
    <div class="adm-fiu-modal-header">
        <h2>Confirm User Deletion</h2>
        <button class="adm-fiu-modal-close" onclick="closeDeleteModal()">&times;</button>
    </div>
    <div class="adm-fiu-modal-body">
        <div class="confirmation-text">
            <p class="danger-text">⚠️ This action cannot be undone!</p>
            <p>You are about to delete the following user(s):</p>
            <div id="deleteUsersList"></div>
            <p><strong>This will also delete all manuscripts associated with these users.</strong></p>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button onclick="closeDeleteModal()" style="flex: 1; padding: 0.8rem; border: 1px solid var(--grey); background: white; border-radius: 4px;">Cancel</button>
            <button onclick="confirmUserDeletion()" style="flex: 1; padding: 0.8rem; background: var(--danger); color: white; border: none; border-radius: 4px;">Delete User(s)</button>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let selectedUsers = new Set();
let usersData = [];

// Tab switching
function switchTab(tabName) {
    // Remove active class from all tabs and buttons
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    
    // Add active class to selected tab and button
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
    
    // Load data for the active tab
    if (tabName === 'users') {
        loadUsers();
    }
}

// User management functions
async function loadUsers(page = 1, search = {}) {
    const token = localStorage.getItem('adminAuthToken');
    try {
        let url = `https://all-branched-end.onrender.com/admin/all-users?page=${page}&limit=20`;
        
        if (search.email) url += `&search=${encodeURIComponent(search.email)}`;
        
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to fetch users');
        
        const data = await response.json();
        usersData = data.users;
        displayUsers(data.users);
        displayPagination(data.pagination);
        
    } catch (error) {
        alert('Error loading users: ' + error.message);
    }
}

function displayUsers(users) {
    const tableBody = document.querySelector('#usersTable tbody');
    tableBody.innerHTML = '';
    
    users.forEach(user => {
        const row = tableBody.insertRow();
        const createdDate = new Date(user.createdAt).toLocaleDateString();
        const userType = user.isInstitutionalUser ? 'Institutional' : 'Regular';
        const institution = user.currentInstitution || user.emailValidation?.institution || 'N/A';
        
        row.innerHTML = `
            <td><input type="checkbox" class="user-checkbox" value="${user.email}" onchange="updateSelectedUsers()"></td>
            <td>${user.email}</td>
            <td>${user.fullName || user.firstName + ' ' + user.lastName}</td>
            <td>${institution}</td>
            <td>${createdDate}</td>
            <td>${userType}</td>
            <td><button onclick="showDeleteConfirmation('${user.email}')" class="delete-btn">Delete</button></td>
        `;
    });
}

function displayPagination(pagination) {
    const paginationDiv = document.getElementById('usersPagination');
    paginationDiv.innerHTML = '';
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'Previous';
    prevBtn.disabled = !pagination.hasPrev;
    prevBtn.onclick = () => loadUsers(pagination.currentPage - 1);
    paginationDiv.appendChild(prevBtn);
    
    // Page numbers
    for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === pagination.currentPage ? 'active' : '';
        pageBtn.onclick = () => loadUsers(i);
        paginationDiv.appendChild(pageBtn);
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'Next';
    nextBtn.disabled = !pagination.hasNext;
    nextBtn.onclick = () => loadUsers(pagination.currentPage + 1);
    paginationDiv.appendChild(nextBtn);
}

function updateSelectedUsers() {
    selectedUsers.clear();
    document.querySelectorAll('.user-checkbox:checked').forEach(checkbox => {
        selectedUsers.add(checkbox.value);
    });
    
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedUsers.size > 0) {
        bulkActions.style.display = 'block';
        selectedCount.textContent = `${selectedUsers.size} users selected`;
    } else {
        bulkActions.style.display = 'none';
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllUsers');
    const checkboxes = document.querySelectorAll('.user-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectedUsers();
}

function searchUsers() {
    const searchParams = {
        email: document.getElementById('userSearchEmail').value,
        institution: document.getElementById('userSearchInstitution').value,
        isInstitutional: document.getElementById('userSearchInstitutional').value,
        dateFrom: document.getElementById('userSearchDateFrom').value,
        dateTo: document.getElementById('userSearchDateTo').value
    };
    
    loadUsers(1, searchParams);
}

function clearUserSearch() {
    document.getElementById('userSearchEmail').value = '';
    document.getElementById('userSearchInstitution').value = '';
    document.getElementById('userSearchInstitutional').value = '';
    document.getElementById('userSearchDateFrom').value = '';
    document.getElementById('userSearchDateTo').value = '';
    loadUsers(1);
}

// Delete functionality
function showDeleteConfirmation(email) {
    const deleteList = document.getElementById('deleteUsersList');
    deleteList.innerHTML = `<ul><li>${email}</li></ul>`;
    selectedUsers.clear();
    selectedUsers.add(email);
    
    document.getElementById('deleteModal').style.display = 'block';
    document.getElementById('deleteModalOverlay').style.display = 'block';
}

function showBulkDeleteConfirmation() {
    if (selectedUsers.size === 0) {
        alert('Please select users to delete');
        return;
    }
    
    const deleteList = document.getElementById('deleteUsersList');
    const userList = Array.from(selectedUsers).map(email => `<li>${email}</li>`).join('');
    deleteList.innerHTML = `<ul>${userList}</ul>`;
    
    document.getElementById('deleteModal').style.display = 'block';
    document.getElementById('deleteModalOverlay').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    document.getElementById('deleteModalOverlay').style.display = 'none';
}

async function confirmUserDeletion() {
    const token = localStorage.getItem('adminAuthToken');
    const emails = Array.from(selectedUsers);
    
    try {
        let response;
        
        if (emails.length === 1) {
            // Single user deletion
            response = await fetch('https://all-branched-end.onrender.com/admin/delete-user-by-email', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ email: emails[0] })
            });
        } else {
            // Bulk deletion
            response = await fetch('https://all-branched-end.onrender.com/admin/delete-multiple-users', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ emails: emails })
            });
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete user(s)');
        }
        
        const result = await response.json();
        alert(result.message || 'User(s) deleted successfully');
        
        closeDeleteModal();
        selectedUsers.clear();
        loadUsers(currentPage); // Reload current page
        
    } catch (error) {
        alert('Error deleting user(s): ' + error.message);
    }
}

// Existing assignment modal functions
function openAssignmentModal(manuscriptId, wordCount, serviceType) {
    const editorId = document.getElementById(`editor-select-${manuscriptId}`).value;
    if (!editorId) {
        alert('Please select an editor from the dropdown.');
        return;
    }
    document.getElementById('modalManuscriptId').value = manuscriptId;
    document.getElementById('modalEditorId').value = editorId;
    document.getElementById('modalEditableWords').value = wordCount;
    document.getElementById('modalEffectiveWords').value = wordCount;
    document.getElementById('modalServiceType').value = serviceType;
    document.getElementById('assignmentModal').style.display = 'block';
    document.getElementById('assignmentModalOverlay').style.display = 'block';
}

function closeAssignmentModal() {
    document.getElementById('assignmentModal').style.display = 'none';
    document.getElementById('assignmentModalOverlay').style.display = 'none';
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('adminAuthToken');
    if (!token) {
        alert('Admin access required. Please log in.');
        window.location.href = '/admin-login.html';
        return;
    }

    // Event listeners for modals
    document.getElementById('closeModalBtn').addEventListener('click', closeAssignmentModal);
    document.getElementById('assignmentModalOverlay').addEventListener('click', closeAssignmentModal);
    document.getElementById('deleteModalOverlay').addEventListener('click', closeDeleteModal);
    
    // Assignment form submission
    document.getElementById('assignmentDetailsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const manuscriptId = document.getElementById('modalManuscriptId').value;
        const assignmentData = {
            editorId: document.getElementById('modalEditorId').value,
            jobCode: document.getElementById('modalJobCode').value,
            jobType: document.getElementById('modalJobType').value,
            serviceType: document.getElementById('modalServiceType').value,
            editableWords: document.getElementById('modalEditableWords').value,
            effectiveEditableWords: document.getElementById('modalEffectiveWords').value,
            targetJournal: document.getElementById('modalTargetJournal').value,
            languageRequirements: document.getElementById('modalLanguage').value,
            subjectArea: document.getElementById('modalSubjectArea').value,
            assignmentStartDate: document.getElementById('modalStartDate').value,
            assignmentReturnDate: document.getElementById('modalReturnDate').value
        };

        try {
            const response = await fetch(`https://all-branched-end.onrender.com/admin/assign-job/${manuscriptId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(assignmentData)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Failed to assign job');
            alert('Job assigned successfully!');
            window.location.reload();
        } catch (error) {
            alert('Failed to assign job: ' + error.message);
        }
    });

    // Load manuscripts (existing functionality)
    try {
        const editorResponse = await fetch('https://all-branched-end.onrender.com/admin/editors', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!editorResponse.ok) throw new Error('Could not fetch editors.');
        const editors = await editorResponse.json();

        const manuscriptResponse = await fetch('https://all-branched-end.onrender.com/admin/dashboard', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!manuscriptResponse.ok) throw new Error('Could not fetch manuscripts.');
        const manuscripts = await manuscriptResponse.json();

        const tableBody = document.querySelector('#manuscriptTable tbody');
        tableBody.innerHTML = ''; 
        
        manuscripts.forEach(doc => {
            const row = tableBody.insertRow();
            let statusInfo = doc.status || 'New';
            if (doc.assignedEditorId) {
                const assignedEditor = editors.find(e => e._id === doc.assignedEditorId);
                statusInfo = `<span style="color: green; font-weight: bold;">Assigned</span> (to: ${assignedEditor ? assignedEditor.fullName : 'Unknown'})`;
            }
            let editorOptions = '<option value="">Select an Editor...</option>';
            editors.forEach(editor => {
                editorOptions += `<option value="${editor._id}">${editor.fullName}</option>`;
            });
            row.innerHTML = `
                <td>${new Date(doc.uploadDate).toLocaleString()}</td>
                <td>${doc.originalName}</td>
                <td>${statusInfo}</td>
                <td><a href="https://all-branched-end.onrender.com/${doc.filePath}" class="adm-fiu-download-btn" download>Download</a></td>
                <td>
                    <div style="display: flex; gap: 5px;">
                       <select id="editor-select-${doc._id}" style="flex-grow: 1;">${editorOptions}</select>
                       <button onclick="openAssignmentModal('${doc._id}', '${doc.wordCount}', '${doc.serviceType}')" class="assign-btn">Assign</button>
                    </div>
                </td>
            `;
        });
    } catch (error) {
        alert('Error loading dashboard: ' + error.message);
    }
});
</script>
</body>
</html>