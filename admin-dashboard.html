<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        :root {
            --blue: #032672;
            --light-blue: #D3E5FF;
            --button-background: linear-gradient(135deg, #eb2525, #af1e1e);
            --white: #ffffff;
            --text-color: #333;
            --grey-light: #f7f9fc;
            --grey: #e5e9f2;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 10px;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--grey-light); color: var(--text-color); margin: 0; padding: 2em; }
        .adm-fiu-dashboard-container { max-width: 1200px; margin: auto; background-color: var(--white); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        h1 { color: var(--blue); border-bottom: 2px solid var(--light-blue); padding-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; table-layout: fixed; }
        th, td { border: 1px solid var(--grey); padding: 12px; text-align: left; vertical-align: middle; word-wrap: break-word; }
        th { background-color: var(--light-blue); color: var(--blue); font-weight: bold; }
        .adm-fiu-download-btn { display: inline-block; padding: 6px 12px; background: var(--blue); color: white; text-decoration: none; border-radius: 4px; }
        .assign-btn { padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        select, .assign-btn { font-size: 0.9rem; padding: 4px; }
    </style>
</head>
<body>
    <div class="adm-fiu-dashboard-container">
        <h1>Manuscript Submissions</h1>
        <table id="manuscriptTable">
            <thead>
                <tr>
                    <th style="width: 15%;">Submission Date</th>
                    <th style="width: 25%;">Original Filename</th>
                    <th style="width: 20%;">Status</th>
                    <th style="width: 10%;">Download</th>
                    <th style="width: 30%;">Assign to Editor</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('adminAuthToken');
            if (!token) {
                alert('Admin access required. Please log in.');
                window.location.href = '/admin-login.html';
                return;
            }

            try {
                
                const editorResponse = await fetch('https://hitex-backend-server.onrender.com/admin/editors', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!editorResponse.ok) throw new Error('Could not fetch editors.');
                const editors = await editorResponse.json();

                
                const manuscriptResponse = await fetch('https://hitex-backend-server.onrender.com/admin/dashboard', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!manuscriptResponse.ok) throw new Error('Could not fetch manuscripts.');
                const manuscripts = await manuscriptResponse.json();

                const tableBody = document.querySelector('#manuscriptTable tbody');
                tableBody.innerHTML = ''; 

                if (manuscripts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No submissions yet.</td></tr>';
                    return;
                }

                manuscripts.forEach(doc => {
                    const row = tableBody.insertRow();
                    
                    let statusInfo = doc.status || 'New';
                    if (doc.assignedEditorId) {
                        const assignedEditor = editors.find(e => e._id === doc.assignedEditorId);
                        statusInfo = `<span style="color: green; font-weight: bold;">Assigned</span> (to: ${assignedEditor ? assignedEditor.fullName : 'Unknown'})`;
                    }

                    let editorOptions = '<option value="">Select an Editor...</option>';
                    editors.forEach(editor => {
                        editorOptions += `<option value="${editor._id}">${editor.fullName}</option>`;
                    });

                    row.innerHTML = `
                        <td>${new Date(doc.uploadDate).toLocaleString()}</td>
                        <td>${doc.originalName}</td>
                        <td>${statusInfo}</td>
                        <td><a href="https://hitex-backend-server.onrender.com/${doc.filePath}" class="adm-fiu-download-btn" download>Download</a></td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                               <select id="editor-select-${doc._id}" style="flex-grow: 1;">${editorOptions}</select>
                               <button onclick="assignJob('${doc._id}')" class="assign-btn">Assign</button>
                            </div>
                        </td>
                    `;
                });

            } catch (error) {
                alert('Error loading dashboard: ' + error.message);
            }
        });

        async function assignJob(manuscriptId) {
            const token = localStorage.getItem('adminAuthToken');
            const editorId = document.getElementById(`editor-select-${manuscriptId}`).value;

            if (!editorId) {
                alert('Please select an editor from the dropdown.');
                return;
            }

            try {
                const response = await fetch(`https://hitex-backend-server.onrender.com/admin/assign-job/${manuscriptId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ editorId })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert('Job assigned successfully!');
                window.location.reload(); // Refresh page to show updated status
            } catch (error) {
                alert('Failed to assign job: ' + error.message);
            }
        }
    </script>
</body>
</html>