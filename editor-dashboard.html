<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Dashboard</title>
    <style>
        :root { 
            --red: #D54C4F;
            --blue: #032672;
            --light-blue: #D3E5FF;
            --button-background: linear-gradient(135deg, #eb2525, #af1e1e);
            --white: #ffffff;
            --text-color: #333;
            --grey-light: #f7f9fc;
            --grey: #e5e9f2;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 10px;
            --accent-light: #fff0eb; 
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--grey-light);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
        }
        .dashboard-container {
            max-width: 1200px;
            margin: auto;
            background-color: var(--white);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        h1 {
            color: var(--blue);
            border-bottom: 2px solid var(--light-blue);
            padding-bottom: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        th, td {
            border: 1px solid var(--grey);
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }
        th {
            background-color: var(--light-blue);
            color: var(--blue);
            font-weight: bold;
        }
        .download-btn {
            display: inline-block;
            padding: 6px 12px;
            background: var(--blue);
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .logout-button {
            display: block;
            width: 120px;
            margin: 2rem 0 0 auto;
            padding: 0.75rem;
            border: none;
            border-radius: var(--radius);
            background: var(--red);
            color: var(--white);
            font-weight: bold;
            cursor: pointer;
        }
        /* --- NEW CSS FOR DEADLINE INDICATORS --- */
        .deadline-urgent {
            background-color: var(--accent-light) !important;
            font-weight: bold;
        }
        .deadline-urgent td:first-child {
            color: var(--red);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>Your Assigned Projects</h1>
        <p>Welcome, <strong id="editorName">Editor</strong>. Here are the manuscripts assigned to you for editing.</p>
        <table id="jobsTable">
            <thead>
                <tr>
                    <th>Assigned Date</th>
                    <th>Filename</th>
                    <th>Word Count</th>
                    <th>Status</th>
                    <th>Deadline</th> <th>Download Original</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <button id="logoutButton" class="logout-button">Logout</button>
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('authToken');
        const user = JSON.parse(localStorage.getItem('user'));

        if (!token || !user) {
            alert('You must be logged in to access this page.');
            window.location.href = 'login.html';
            return;
        }

        document.getElementById('editorName').textContent = user.fullName || 'Editor';

        // --- NEW: Helper function to format the countdown ---
        function formatTimeRemaining(deadlineString) {
            const deadline = new Date(deadlineString);
            const now = new Date();
            const diff = deadline.getTime() - now.getTime();

            if (diff <= 0) {
                return '<span style="color: var(--red);">Overdue</span>';
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            let parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.slice(0, 2).join(', ') + ' left'; // Show max 2 units, e.g., "3d, 10h left"
        }

        try {
            const response = await fetch('https://hitex-backend-server.onrender.com/editor/my-jobs', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Could not fetch your assigned jobs.');
            
            const assignedJobs = await response.json();
            const tableBody = document.querySelector('#jobsTable tbody');

            if (assignedJobs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">You have no jobs assigned to you yet.</td></tr>';
                return;
            }
            
            assignedJobs.forEach(job => {
                const row = tableBody.insertRow();
                
                const deadline = new Date(job.deadline);
                const daysRemaining = Math.ceil((deadline - new Date()) / (1000 * 60 * 60 * 24));

                if (daysRemaining <= 3) {
                    row.classList.add('deadline-urgent');
                }
                
                const deadlineFormatted = deadline.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });
                
                // Use the new countdown function for the deadline column
                row.innerHTML = `
                    <td>${new Date(job.uploadDate).toLocaleDateString()}</td>
                    <td>${job.originalName}</td>
                    <td>${job.wordCount}</td>
                    <td>${job.status || 'Assigned'}</td>
                    <td>${deadlineFormatted} <br><strong>${formatTimeRemaining(job.deadline)}</strong></td>
                    <td>
                        <a href="https://hitex-backend-server.onrender.com/${job.filePath}" class="download-btn" download>Download</a>
                    </td>
                `;
            });

        } catch (error) {
            console.error('Failed to load dashboard:', error);
            document.querySelector('#jobsTable tbody').innerHTML = '<tr><td colspan="6" style="color:red; text-align:center;">Failed to load assigned jobs.</td></tr>';
        }

        // --- Logout Button Logic ---
        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            alert('You have been logged out.');
            window.location.href = 'client-login.html';
        });
    });
</script>
</body>
</html>